(function(){var f=YAHOO.util.Dom;var c=Alfresco.util.encodeHTML,d=Alfresco.util.combinePaths,e=Alfresco.util.siteURL,a=Alfresco.util.isValueSet;beCPG.custom.DocumentList=function b(o){beCPG.custom.DocumentList.superclass.constructor.call(this,o);YAHOO.Bubbling.on("doclistMetadata",this.onDoclistMetadata,this);return this};YAHOO.extend(beCPG.custom.DocumentList,Alfresco.DocumentList,{onDoclistMetadata:function(s,q){var r=q[1].metadata,t=this;if(r!==null&&beCPG.util.isEntity(r.parent)){var v=f.get(t.id+"-becpg-entityFolder-message"),p=r.parent.type.split(":")[1],o;var u="product";if(p=="rawMaterial"||p=="finishedProduct"||p=="semiFinishedProduct"||p=="localSemiFinishedProduct"||p=="packagingKit"||p=="packagingMaterial"||p=="resourceProduct"){u="product"}else{if(p=="projet"||p=="systemEntity"||p=="aclGroup"||p=="entityTplFolder"){u=p}else{u="entity"}}o="<img  src='"+Alfresco.constants.PROXY_URI+"/api/node/"+r.parent.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true' class='node-thumbnail' width='48'>";o+="<span >"+Alfresco.util.message("page.documentlibrary.instructions."+u)+"</span>";v.innerHTML=o;this.widgets.viewEntityLists=Alfresco.util.createYUIButton(t,"viewEntityLists-button",function(y,x,w){window.location.href=beCPG.util.entityURL(t.options.siteId,t.doclistMetadata.parent.nodeRef,t.doclistMetadata.parent.type)});f.removeClass(t.id+"-becpg-entityFolder-buttons","hidden");f.removeClass(t.id+"-becpg-entityFolder-instructions","hidden")}else{f.addClass(t.id+"-becpg-entityFolder-instructions","hidden")}},_buildDocListParams:function k(t){var q=a(this.options.siteId),r={path:this.currentPath,type:this.options.showFolders?"all":"documents",site:this.options.siteId,container:this.options.containerId,filter:this.currentFilter};if(this.options.disableSiteMode){q=false}if(this.options.usePagination){r.page=this.widgets.paginator.getCurrentPage()||this.currentPage;r.pageSize=this.widgets.paginator.getRowsPerPage()}if(typeof t==="object"){r=YAHOO.lang.merge(r,t)}var p=("alfresco://company/shared"==this.options.rootNode);var o=q?"site/{site}/{container}":p?"node/alfresco/company/shared":"node/alfresco/user/home",s=YAHOO.lang.substitute("{type}/"+o+(r.filter.filterId==="path"?"{path}":""),{type:encodeURIComponent(r.type),site:encodeURIComponent(r.site),container:encodeURIComponent(r.container),path:d("/",Alfresco.util.encodeURIPath(r.path))});s+="?filter="+encodeURIComponent(r.filter.filterId);if(r.filter.filterData&&r.filter.filterId!=="path"){s+="&filterData="+encodeURIComponent(r.filter.filterData)}if(this.options.usePagination){s+="&size="+r.pageSize+"&pos="+r.page}s+="&sortAsc="+this.options.sortAscending+"&sortField="+encodeURIComponent(this.options.sortField);if(!q){s+="&libraryRoot="+encodeURIComponent(this.options.rootNode.toString())}s+="&view="+this.actionsView+"&noCache="+new Date().getTime();return s},onDocumentListDrop:function l(y){try{if(y.dataTransfer.files!==undefined&&y.dataTransfer.files!==null&&y.dataTransfer.files.length>0){var v=Alfresco.getDNDUploadProgressInstance();var p=false;var z="",s,r;r=y.dataTransfer.files.length;for(s=0;s<r;s++){if(y.dataTransfer.files[s].size>0){p=true}else{z+='"'+y.dataTransfer.files[s].fileName+'", '}}if(!p){z=z.substring(0,z.lastIndexOf(", "));Alfresco.util.PopupManager.displayMessage({text:v.msg("message.zeroByteFiles",z)})}if(p&&v.uploadMethod===v.INMEMORY_UPLOAD){var C=0;r=y.dataTransfer.files.length;for(s=0;s<r;s++){C+=y.dataTransfer.files[s].size}if(C>v.getInMemoryLimit()){p=false;Alfresco.util.PopupManager.displayPrompt({text:v.msg("inmemory.uploadsize.exceeded",Alfresco.util.formatFileSize(v.getInMemoryLimit()))})}}if(p){var x=this.currentPath,o=x.substring(x.lastIndexOf("/")+1),A=this.doclistMetadata.parent?this.doclistMetadata.parent.nodeRef:null;var D=this.widgets.dataTable.getRecord(y.target);if(D!==null){var w=this.widgets.dataTable.getColumn(y.target),u=D.getData();if(y.target.tagName=="IMG"||y.target.className=="droppable"){var B=u.location;o=B.file;x=d(B.path,B.file);A=u.nodeRef}}f.removeClass(this.widgets.dataTable.getTrEl(y.target),"dndFolderHighlight");f.removeClass(this.widgets.dataTable.getContainerEl(),"dndDocListHighlight");var t={files:y.dataTransfer.files,uploadDirectoryName:o,filter:[],mode:v.MODE_MULTI_UPLOAD,thumbnails:"doclib",onFileUploadComplete:{fn:this.onFileUploadComplete,scope:this}};if(a(this.options.siteId)&&!this.options.disableSiteMode){t.siteId=this.options.siteId;t.containerId=this.options.containerId;t.uploadDirectory=x}else{t.destination=A}v.show(t)}}else{Alfresco.logger.debug("DL_onDocumentListDrop: A drop event was detected, but no files were present for upload: ",y.dataTransfer)}}catch(q){Alfresco.logger.error("DL_onDocumentListDrop: The following error occurred when files were dropped onto the Document List: ",q)}y.stopPropagation();y.preventDefault()},onLikes:function n(u){var r=u;if(typeof this.viewRenderers[this.options.viewRendererName]==="object"){r=this.viewRenderers[this.options.viewRendererName].getDataTableRecordIdFromRowElement(this,u)}var v=this.widgets.dataTable.getRecord(r),s=v.getData(),t=s.jsNode.nodeRef,p=s.likes;p.isLiked=!p.isLiked;p.totalLikes+=(p.isLiked?1:-1);var w={successCallback:{fn:function o(D,A){var E=D.json.data;if(E){var C=this._findRecordByParameter(A,"nodeRef"),x=C.getData(),B=x.node,y=x.likes;y.totalLikes=E.ratingsCount;this.widgets.dataTable.updateRow(C,x);if(y.isLiked){var z={fileName:x.fileName,nodeRef:B.nodeRef};if(beCPG.util.isEntity(x)){this.modules.actions.postActivity(this.options.siteId,"entity-liked","entity-data-lists",z)}else{if(B.isContainer){this.modules.actions.postActivity(this.options.siteId,"folder-liked","folder-details",z)}else{this.modules.actions.postActivity(this.options.siteId,"file-liked","document-details",z)}}}}},scope:this,obj:t.toString()},failureCallback:{fn:function q(B,z){var A=this._findRecordByParameter(z,"nodeRef"),x=A.getData(),y=x.likes;y.isLiked=!y.isLiked;y.totalLikes+=(y.isLiked?1:-1);this.widgets.dataTable.updateRow(A,x);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure",x.displayName)})},scope:this,obj:t.toString()}};if(p.isLiked){this.services.likes.set(t,1,w)}else{this.services.likes.remove(t,w)}this.widgets.dataTable.updateRow(v,s)}});Alfresco.DocumentList.generateFileFolderLinkMarkup=function i(q,o){var s=o.jsNode,p;if(s.isLink&&a(q.options.siteId)&&o.location.site&&o.location.site.name!==q.options.siteId){if(s.isContainer){p=e("documentlibrary?path="+encodeURIComponent(o.location.path),{site:o.location.site.name})}else{p=q.getActionUrls(o,o.location.site.name).documentDetailsUrl}}else{if(s.isContainer){if(beCPG.util.isEntity(o)){p=q.getActionUrls(o).documentDetailsUrl.replace("document-details?","entity-data-lists?list=View-properties&")}else{if(o.parent.isContainer){p='#" class="filter-change" rel="'+Alfresco.DocumentList.generatePathMarkup(o.location)}else{if(o.location.path==="/"){p='#" class="filter-change" rel="'+Alfresco.DocumentList.generateFilterMarkup({filterId:"path",filterData:d(o.location.path,"")})}else{p="#"}}}}else{var r=q.getActionUrls(o);if(a(q.options.siteId)&&((o.location.repoPath!=null&&o.location.repoPath.length>0&&o.location.repoPath.indexOf("/Sites/"+q.options.siteId)==0)||(o.location.path!=null&&o.location.path.length>0&&!a(o.location.site)))){r=q.getActionUrls(o,q.options.siteId)}if(s.isLink&&s.linkedNode.isContainer){p=r.folderDetailsUrl}else{p=r.documentDetailsUrl}}}return'<a href="'+p+'">'};Alfresco.DocumentListSimpleViewRenderer.prototype.renderCellThumbnail=function h(o,q,C,u,z){var p=C.getData(),y=p.jsNode,r=y.properties,F=p.displayName,s=y.isContainer,t=y.isLink,v=F.substring(F.lastIndexOf(".")),A=y.nodeRef.nodeRef,D=beCPG.util.isEntity(p);if(D){v=y.type.substring(y.type.lastIndexOf(":"))}var E;u.width=40;f.setStyle(q,"width",u.width+"px");f.setStyle(q.parentNode,"width",u.width+"px");if(s&&!D){q.innerHTML='<span class="folder-small">'+(t?'<span class="link"></span>':"")+(o.dragAndDropEnabled?'<span class="droppable"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(o,p)+'<img id="'+A+'" src="'+this.getFolderIcon(p.node)+'" /></a>';E=new YAHOO.util.DDTarget(A)}else{var w=o.id+"-preview-"+C.getId();var B=Alfresco.util.getFileIcon(F,y.type);if(B=="generic-file-32.png"){B=Alfresco.util.getFileIconByMimetype(y.mimetype)}q.innerHTML='<span id="'+w+'" class="icon32">'+(t?'<span class="link"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(o,p)+'<img id="'+A+'" src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+B+'" alt="'+v+'" title="'+c(F)+'" /></a></span>';o.previewTooltips.push(w)}var x=new Alfresco.DnD(A,o)};Alfresco.DocumentListViewRenderer.prototype.renderCellThumbnail=function j(B,A,D,w,s){var v=D.getData(),t=v.jsNode,y=t.properties,p=v.displayName,r=t.isContainer,C=beCPG.util.isEntity(v),u=t.isLink,x=p.substring(p.lastIndexOf(".")),o=t.nodeRef.nodeRef;var z;if(window.location.href.search(/\/sharedfiles/)!=-1&&v.location.path.search("/Shared")==0){v.location.path=v.location.path.substring(7)}w.width=this.thumbnailColumnWidth;f.setStyle(A,"width",w.width+"px");f.setStyle(A.parentNode,"width",w.width+"px");if((r||(u&&t.linkedNode.isContainer))&&!C){A.innerHTML='<span class="folder">'+(u?'<span class="link"></span>':"")+(B.dragAndDropEnabled?'<span class="droppable"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(B,v)+'<img id="'+o+'" src="'+this.getFolderIcon(v.node)+'" /></a>';z=new YAHOO.util.DDTarget(o)}else{A.innerHTML='<span class="thumbnail">'+(u?'<span class="link"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(B,v)+'<img id="'+o+'" src="'+Alfresco.DocumentList.generateThumbnailUrl(v)+'" alt="'+x+'" title="'+c(p)+'" /></a></span>'}var q=new Alfresco.DnD(o,B)};Alfresco.DocumentList.generateLikes=function m(r,o){var s=o.node,p=o.likes,t="like."+(s.isContainer&&!beCPG.util.isEntity(o)?"folder.":"document."),q="";if(p.isLiked){q='<a class="like-action enabled" title="'+r.msg(t+"remove.tip")+'" tabindex="0"></a>'}else{q='<a class="like-action" title="'+r.msg(t+"add.tip")+'" tabindex="0">'+r.msg(t+"add.label")+"</a>"}q+='<span class="likes-count">'+c(p.totalLikes)+"</span>";return q};Alfresco.DocumentList.generateComments=function g(r,o){var u=o.node,t=r.getActionUrls(o),p=t[u.isContainer?"folderDetailsUrl":"documentDetailsUrl"]+"#comment",v="comment."+(u.isContainer&&!beCPG.util.isEntity(o)?"folder.":"document.");if(beCPG.util.isEntity(o)){p=p.replace("folder-details?","entity-data-lists?list=View-properties&")}var s=(u.properties["fm:commentCount"]!==undefined);var q='<a href="'+p+'" class="comment'+(s?" hasComments":"")+'" title="'+r.msg(v+"tip")+'" tabindex="0">'+r.msg(v+"label")+"</a>";if(s){q+='<span class="comment-count">'+c(u.properties["fm:commentCount"])+"</span>"}return q}})();