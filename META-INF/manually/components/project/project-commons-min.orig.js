(function(){var c=YAHOO.Bubbling,g=Alfresco.util.encodeHTML;var k=Alfresco.util.generateDomId(null,"task");var h=Alfresco.util.generateDomId(null,"comment");beCPG.component.ProjectCommons={};beCPG.component.ProjectCommons.prototype={cache:[],onActionShowTask:function e(t){var u=this;var v=function s(y,z){Alfresco.util.populateHTML([z.id+"-dialogTitle",u.msg("label.edit-row.title")])};var p=t.replace("node-","").split("|");var q=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?entityNodeRef={entityNodeRef}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"node",itemId:p[0],mode:"edit",submitType:"json",entityNodeRef:p[1]!="#access_forbidden"?p[1]:""});var w=new Alfresco.module.SimpleDialog(this.id+"-editCharacts-"+Alfresco.util.generateDomId());w.setOptions({width:"34em",templateUrl:q,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:v,scope:this},onSuccess:{fn:function x(y){c.fire(u.scopeId+"dataItemUpdated",{nodeRef:p[1],callback:function(z){Alfresco.util.PopupManager.displayMessage({text:u.msg("message.details.success")})}})},scope:this},onFailure:{fn:function r(y){Alfresco.util.PopupManager.displayMessage({text:u.msg("message.details.failure")})},scope:this}}).show()},onActionCommentTask:function e(r){var p=r.replace("node-","").split("|"),s=p[1]!="#access_forbidden"?p[1]:"";var q=Alfresco.constants.URL_SERVICECONTEXT+"modules/comments/list?nodeRef="+p[0]+"&activityType=task&entityNodeRef="+s;this._showPanel(q,this.id+"_comments",p[1])},getOverdueClass:function o(u,p){var q=0,r=u.itemData.prop_pjt_projectOverdue,t=this.extractDates(u),s=p!=null?"-"+p:"";if(r.value!=null&&t.start!=null&&t.due!=null){q=100*(r.value/(t.due.getTime()-t.start.getTime()))*24*60*60*1000}if(q>45){return"overdue-45plus"+s}if(q>30){return"overdue-30to45"+s}if(q>15){return"overdue-15to29"+s}if(q>0){return"overdue-0to14"+s}return"overdue-negative"+s},extractDates:function(q,v,s){var p=null,u=null,r=null;if(s){p=q.itemData["prop_pjt_tlStart"].value;u=q.itemData["prop_pjt_tlEnd"].value;u=u!=null?this.resetDate(Alfresco.util.fromISO8601(u)):null;p=p!=null?this.resetDate(Alfresco.util.fromISO8601(p)):this.resetDate(v);if(u==null){var t=q.itemData["prop_pjt_tlDuration"].value;if(t==null){if(q.itemData["prop_pjt_tlIsMilestone"]!=null&&q.itemData["prop_pjt_tlIsMilestone"].value){t=1}else{t=0}}u=new Date(p.getTime()+t*24*60*60*1000)}return{start:p,end:u}}p=q.itemData.prop_pjt_projectStartDate.value;u=q.itemData.prop_pjt_projectCompletionDate.value;r=q.itemData.prop_pjt_projectDueDate.value;p=p!=null?this.resetDate(Alfresco.util.fromISO8601(p)):new Date();u=u!=null?this.resetDate(Alfresco.util.fromISO8601(u)):null;r=r!=null?this.resetDate(Alfresco.util.fromISO8601(r)):this.computeDueDate(p,q);return{start:p,end:u,due:r}},computeDueDate:function(p,s){var v=s.itemData.dt_pjt_taskList;var t=p,r=p;for(j in v){var q=v[j];var w=q.nodeRef;var x=this.cache[w];if(!x){for(var y in q.itemData["assoc_pjt_tlPrevTasks"]){var u=q.itemData["assoc_pjt_tlPrevTasks"][y].value;if(this.cache[u]!=null&&this.cache[u].end!=null&&this.cache[u].end.getTime()>r.getTime()){r=this.cache[u].end}}x=this.extractDates(q,r,true);this.cache[w]=x}t=x.end}return t},resetDate:function a(p){if(p==null){return new Date()}p.setHours(0);p.setMinutes(0);p.setSeconds(0);return p},getTaskTitle:function l(p,t,u,r){var q='<span class="task-status task-status-'+p.itemData["prop_pjt_tlState"].value+'">',s="";if(p.permissions.userAccess.edit){q+='<span class="node-'+p.nodeRef+"|"+t+'"><a href="" class="theme-color-1 '+k+'" title="'+this.msg("link.title.task-edit")+'" >'+p.itemData["prop_pjt_tlTaskName"].displayValue}else{q+='<span class="node-'+p.nodeRef+"|"+t+'">'+p.itemData["prop_pjt_tlTaskName"].displayValue}if(p.itemData["prop_pjt_tlState"].value=="InProgress"){if(p.itemData["prop_pjt_completionPercent"]&&p.itemData["prop_pjt_completionPercent"].value!=null){s+='<span title="'+this.msg("completion.title")+'">'+p.itemData["prop_pjt_completionPercent"].displayValue+"%</span>"}}if(p.itemData["prop_pjt_tlRealDuration"]&&p.itemData["prop_pjt_tlRealDuration"].value!=null&&p.itemData["prop_pjt_tlRealDuration"].value>p.itemData["prop_pjt_tlDuration"].value){if(s.length>0){s+=" - "}s+='<span class="red" title="'+this.msg("overdue.title")+'">'+Alfresco.util.encodeHTML(p.itemData["prop_pjt_tlRealDuration"].value-p.itemData["prop_pjt_tlDuration"].value)+" "+this.msg("overdue.day")+"</span>"}if(s.length>0){q+=" ("+s+")"}if(p.permissions.userAccess.edit){q+="</a>"}q+="</span>";q+='<span class="node-'+p.nodeRef+"|"+t+'">';q+='<a class="task-comments '+h+'" title="'+this.msg("link.title.comment-task")+'" href="" >';if(p.itemData["prop_fm_commentCount"]&&p.itemData["prop_fm_commentCount"].value){q+=p.itemData["prop_fm_commentCount"].value}else{q+="&nbsp;"}q+="</a></span></span>";return q},getDeliverableTitle:function f(p,t){var r='<span class="delivrable-status delivrable-status-'+p.itemData["prop_pjt_dlState"].value+'">';var s=p.itemData["assoc_pjt_dlContent"];if(s.length>0){r+='<span class="doc-file"><a title="'+this.msg("link.title.open-document")+'" href="'+beCPG.util.entityURL(s[0].siteId,s[0].value,"document")+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(s[0].displayValue,"cm:content",16)+'" /></a></span>'}var q=p.itemData["prop_pjt_dlUrl"]!=null?p.itemData["prop_pjt_dlUrl"].value:null;if(q!=null&&q.length>0){r+='<span class="doc-url"><a title="'+this.msg("link.title.open-link")+'" href="'+q+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/link-16.png" /></a></span>'}if(p.permissions.userAccess.edit){r+='<span class="node-'+p.nodeRef+"|"+t+'"><a class="theme-color-1 '+k+'" title="'+this.msg("link.title.deliverable-edit")+'" >'+p.itemData["prop_pjt_dlDescription"].displayValue+"</a></span>"}else{r+='<span class="node-'+p.nodeRef+"|"+t+'">'+p.itemData["prop_pjt_dlDescription"].displayValue+"</span>"}r+='<span class="node-'+p.nodeRef+"|"+t+'">';r+='<a class="task-comments '+h+'" title="'+this.msg("link.title.comment-task")+'" href="" >';if(p.itemData["prop_fm_commentCount"]&&p.itemData["prop_fm_commentCount"].value){r+=p.itemData["prop_fm_commentCount"].value}else{r+="&nbsp;"}r+="</a></span>";r+="</span>";return r},getPriorityImg:function m(p,s){var r=p.itemData.prop_pjt_projectPriority.value,t={"1":"high","2":"medium","3":"low"},q=t[r+""];return'<img class="priority" src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+q+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+q))+'"/>'},getProjectTitle:function n(s,u,z){var r=null,y=null,q=null,w="";var x=s.itemData.prop_cm_name.displayValue,p=s.itemData.prop_bcpg_code.displayValue,t="",v="";r=beCPG.util.entityURL(s.siteId,s.nodeRef,"pjt:project",null,"View-properties");y=beCPG.util.entityURL(s.siteId,s.nodeRef,"pjt:project");q=beCPG.util.entityDocumentsURL(s.siteId,s.path,x);if(s.version&&s.version!==""){w='<span class="document-version">'+s.version+"</span>"}if(u){t=s.itemData.prop_pjt_projectOverdue.displayValue!=null?g(s.itemData.prop_pjt_projectOverdue.displayValue)+"&nbsp;"+this.msg("overdue.day"):"";v+='<span class="'+this.getOverdueClass(s,z?32:null)+'" title="'+t+'">'}else{v+='<span class="project-title"><a class="folder-link" href="'+q+'" title="'+this.msg("link.title.open-folder")+'">&nbsp;</a>'}if(u){v+=this.getPriorityImg(s,z)}v+='<a class="theme-color-1" href="'+(u?r:y)+'" title="'+(u?"":this.msg("actions.entity.view-tasks"))+'">'+p+"&nbsp;-&nbsp;"+g(x)+"</a></span>"+w;return v},getTaskColor:function b(p){if(p.itemData["assoc_pjt_tlTaskLegend"][0]!=null){var q=p.itemData["assoc_pjt_tlTaskLegend"][0].value;for(i in this.taskLegends){if(this.taskLegends[i].id==q){return this.taskLegends[i].color.replace("#","")}}}return"006600"},initTaskHandlers:function d(){var s=this;var q=function p(v,u){var t=YAHOO.Bubbling.getOwnerByTagName(u[1].anchor,"span");if(t!==null){s.onActionShowTask.call(s,t.className,t)}return true};YAHOO.Bubbling.addDefaultAction(k,q);var r=function p(v,u){var t=YAHOO.Bubbling.getOwnerByTagName(u[1].anchor,"span");if(t!==null){s.onActionCommentTask.call(s,t.className,t)}return true};YAHOO.Bubbling.addDefaultAction(h,r)}}})();