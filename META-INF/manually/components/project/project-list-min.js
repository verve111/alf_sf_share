var g;!function(){var t=YAHOO.util.Dom,e=Alfresco.util.encodeHTML;beCPG.component.ProjectList=function(t,e){return this.view=e,beCPG.component.ProjectList.superclass.constructor.call(this,t),YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this),"resources"==e?this.setOptions({sortable:!1,usePagination:!0,useFilter:!0,itemType:"pjt:taskList",list:"projectList",sortId:"TaskResources",extraParams:"resources",formWidth:"65em"}):this.setOptions({sortable:!1,usePagination:!0,useFilter:!0,itemType:"pjt:project",list:"projectList",groupBy:"prop_pjt_projectHierarchy2",sortId:"ProjectList",groupFormater:function(t,e){var a="";return null!=e.getData("itemData").prop_pjt_projectHierarchy1&&null!=e.getData("itemData").prop_pjt_projectHierarchy1.displayValue&&(a+=e.getData("itemData").prop_pjt_projectHierarchy1.displayValue),a.length>0&&(a+=" - "),null!=e.getData("itemData").prop_pjt_projectHierarchy2&&null!=e.getData("itemData").prop_pjt_projectHierarchy2.displayValue&&(a+=e.getData("itemData").prop_pjt_projectHierarchy2.displayValue),a},hiddenColumns:["prop_pjt_projectHierarchy1","prop_pjt_projectHierarchy2","prop_bcpg_code","prop_pjt_projectCompletionDate","prop_pjt_projectDueDate","prop_pjt_projectState"],formWidth:"65em"}),this},YAHOO.extend(beCPG.component.ProjectList,beCPG.module.EntityDataGrid),YAHOO.lang.augmentProto(beCPG.component.ProjectList,beCPG.component.ProjectCommons),YAHOO.lang.augmentObject(beCPG.component.ProjectList.prototype,{view:"dataTable",taskLegends:[],onReady:function(){JSGantt.register(this);var e=Alfresco.constants.PROXY_URI+"becpg/project/info"+(null!=this.options.siteId&&this.options.siteId.length>0?"?site="+this.options.siteId:"");Alfresco.util.Ajax.request({url:e,successCallback:{fn:function(e){var a=e.json.legends;this.options.parentNodeRef=e.json.parentNodeRef;var i="";for(var s in a){var r={id:a[s].nodeRef,label:a[s].label,color:a[s].color.replace("#",""),nbProjects:a[s].nbProjects};this.taskLegends.push(r),i+='<div style="white-space: nowrap;display:inline-block;margin-right:5px;"><span class="task-legend" style="background-color:#'+r.color+'" ></span><span><a href='+Alfresco.util.siteURL("project-list?view="+this.view+"#filter=filterform|%7B%22prop_pjt_projectState%22%3A%22InProgress%22%2C%22prop_pjt_projectLegends%22%3A%22"+encodeURIComponent(r.id)+"%22%7D")+">"+r.label+" ("+r.nbProjects+")</a></span>&nbsp;</div>"}t.get(this.id+"-legend").innerHTML=i,"gantt"==this.view&&(this.options.pageSize=10,this.initGantt()),"resources"==this.view&&this.initResources(),this.initDataTable()},scope:this},failureCallback:{fn:function(){},scope:this}})},initDataTable:function(){beCPG.component.ProjectList.superclass.onReady.call(this),this.populateDataGrid(),this.initTaskHandlers()},_buildDataGridParams:function(t){var e=this.dataRequestFields;"resources"==this.view&&(e=["pjt_tlTaskName","pjt_tlIsMilestone","pjt_tlDuration","pjt_tlResources","pjt_tlTaskLegend","pjt_tlState","pjt_completionPercent","pjt_tlStart","pjt_tlEnd","pjt_tlWorkflowInstance","fm_commentCount","pjt_project|cm_name|pjt_projectHierarchy1|pjt_projectHierarchy2|pjt_completionPercent|bcpg_code"]);var a={fields:e,page:t&&t.page?t.page:this.currentPage,queryExecutionId:this.queryExecutionId,extraParams:this.options.extraParams};return t&&t.filter&&(a.filter={filterOwner:t.filter.filterOwner,filterId:t.filter.filterId,filterData:t.filter.filterData,filterParams:this._createFilterURLParameters(t.filter,this.options.filterParameters)}),a},initGantt:function(){var e=function(){var e=this.widgets.dataTable.getRecordSet();if(0!=e.getLength()){g=new JSGantt.GanttChart("g",t.get(this.id+"-gantt"),null!=g?g.getFormat():null),g.setDateInputFormat("mediumDate"),g.setDateDisplayFormat("mediumDate"),g.setCaptionType("Resource");for(var a=0;a<e.getLength();a++){var i=e.getRecord(a),s=i.getData(),r=s.nodeRef,o='<span class="'+this.getOverdueClass(s)+'">'+this.getProjectTitle(s)+"</span>",n=i.getData("itemData").assoc_pjt_projectManager.displayValue;n&&null!=n&&n.length>0&&(n='<span class="resource-title">'+n+"</span>");var l=i.getData("itemData").prop_pjt_completionPercent.value,p=this.extractDates(s);g.AddTaskItem(new JSGantt.TaskItem(r,o,p.start,p.due,"FFBC00","",0,n,l,1,0,0));var c=p.start,u=i.getData("itemData").dt_pjt_taskList;for(j in u){var d=u[j],h=d.nodeRef,m="";for(var f in d.itemData.assoc_pjt_tlPrevTasks){var _=d.itemData.assoc_pjt_tlPrevTasks[f].value;m.length>0&&(m+=","),m+=_,null!=this.cache[_]&&null!=this.cache[_].end&&this.cache[_].end.getTime()>c.getTime()&&(c=this.cache[_].end)}var D=r;null!=d.itemData.prop_bcpg_parentLevel.value&&(D=d.itemData.prop_bcpg_parentLevel.value);var v=d.itemData.prop_pjt_tlIsGroup.value?1:0,y=d.itemData.prop_pjt_tlIsMilestone.value,T=d.itemData.prop_pjt_completionPercent.value,b=d.itemData.assoc_pjt_tlResources.length>0?'<span class="resource-title">'+d.itemData.assoc_pjt_tlResources[0].displayValue+"</span>":null,P=this.cache[h];P||(P=this.extractDates(d,c,!0),this.cache[h]=P),g.AddTaskItem(new JSGantt.TaskItem(h,this.getTaskTitle(d,s.nodeRef,P.start),P.start,P.end,this.getTaskColor(d),null,y?1:0,b,T,v,D,1,m))}}g.Draw(),g.DrawDependencies()}else Alfresco.util.populateHTML([this.id+"-gantt",'<div class="yui-dt-liner">'+this.msg("message.empty")+"</div>"])};this.cache=[],this.extraAfterDataGridUpdate.push(e)},initResources:function(){var e=function(){var e=this.widgets.dataTable.getRecordSet();if(0!=e.getLength()){g=new JSGantt.GanttChart("g",t.get(this.id+"-gantt"),null!=g?g.getFormat():null),g.setDateInputFormat("shortDate"),g.setDateDisplayFormat("shortDate"),g.setCaptionType("Resource");for(var a=new Date,i=[],s=0;s<e.getLength();s++){var r=e.getRecord(s),o=r.getData(),n=o.nodeRef,l=o.itemData.dt_pjt_project.itemData.prop_cm_name.displayValue,p=o.itemData.prop_pjt_tlIsMilestone.value,c=o.itemData.prop_pjt_completionPercent.value,u=o.itemData.assoc_pjt_tlResources.length>0?o.itemData.assoc_pjt_tlResources[0].value:null,d=o.itemData.assoc_pjt_tlResources.length>0?'<span class="resource-title">'+o.itemData.assoc_pjt_tlResources[0].displayValue+"</span>":null;i[u]||g.AddTaskItem(new JSGantt.TaskItem(u,d,null,null,"FFBC00","",0,"",0,1,0,1)),i[u]=!0;var h=this.cache[n];h||(h=this.extractDates(o,a,!0),this.cache[n]=h),o.itemData.prop_pjt_tlTaskName.displayValue=o.itemData.dt_pjt_project.itemData.prop_bcpg_code.displayValue+" - "+o.itemData.prop_pjt_tlTaskName.displayValue;var m=this.getTaskTitle(o,null,h.start);g.AddTaskItem(new JSGantt.TaskItem(n,m,h.start,h.end,this.getTaskColor(o),null,p?1:0,l,c,0,u,1))}g.Draw(),g.DrawDependencies()}else Alfresco.util.populateHTML([this.id+"-gantt",'<div class="yui-dt-liner">'+this.msg("message.empty")+"</div>"])};this.cache=[],this.extraAfterDataGridUpdate.push(e)},onFilterChanged:function(a,i){var s=Alfresco.util.cleanBubblingObject(i[1]);"filterform"==s.filterId?t.get(this.id+"-filterTitle").innerHTML=e(this.msg("filter."+s.filterId)):"tag"==s.filterId?t.get(this.id+"-filterTitle").innerHTML=e(this.msg("filter."+s.filterId,s.filterData)):t.get(this.id+"-filterTitle").innerHTML=e(this.msg("filter."+s.filterId+(s.filterData?"."+s.filterData:""),s.filterData))},onDataItemCreated:function(t,e){var a=e[1];if(a&&null!==a.nodeRef){var i=new Alfresco.util.NodeRef(a.nodeRef),s=this.options.itemUrl+i.uri+(null!=this.options.entityNodeRef&&this.options.entityNodeRef.length>0?"?entityNodeRef="+this.options.entityNodeRef+"&":"?")+"itemType="+encodeURIComponent(null!=this.options.itemType?this.options.itemType:this.datalistMeta.itemType)+"&dataListName="+encodeURIComponent(null!=this.datalistMeta.name?this.datalistMeta.name:this.options.list);Alfresco.util.Ajax.jsonPost({url:s,dataObj:this._buildDataGridParams(),successCallback:{fn:function(t){if(t.json&&null!==t.json.item){var e=t.json.item;YAHOO.Bubbling.fire("changeFilter",filter={filterOwner:"Alfresco.component.AllFilter",filterId:"projects",filterData:e.itemData.prop_pjt_projectState.value})}},scope:this},failureCallback:{fn:function(t){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create.refresh.failure")})},scope:this}})}}},!0)}();