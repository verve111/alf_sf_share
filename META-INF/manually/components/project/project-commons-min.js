!function(){var t=YAHOO.Bubbling,e=Alfresco.util.encodeHTML,a=Alfresco.util.generateDomId(null,"task"),s=Alfresco.util.generateDomId(null,"comment");beCPG.component.ProjectCommons={},beCPG.component.ProjectCommons.prototype={cache:[],onActionShowTask:function(e){var a=this,s=function(t,e){Alfresco.util.populateHTML([e.id+"-dialogTitle",a.msg("label.edit-row.title")])},l=e.replace("node-","").split("|"),i=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?entityNodeRef={entityNodeRef}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"node",itemId:l[0],mode:"edit",submitType:"json",entityNodeRef:"#access_forbidden"!=l[1]?l[1]:""}),n=new Alfresco.module.SimpleDialog(this.id+"-editCharacts-"+Alfresco.util.generateDomId());n.setOptions({width:"34em",templateUrl:i,actionUrl:null,destroyOnHide:!0,doBeforeDialogShow:{fn:s,scope:this},onSuccess:{fn:function(e){t.fire(a.scopeId+"dataItemUpdated",{nodeRef:l[1],callback:function(t){Alfresco.util.PopupManager.displayMessage({text:a.msg("message.details.success")})}})},scope:this},onFailure:{fn:function(t){Alfresco.util.PopupManager.displayMessage({text:a.msg("message.details.failure")})},scope:this}}).show()},onActionCommentTask:function(t){var e=t.replace("node-","").split("|"),a="#access_forbidden"!=e[1]?e[1]:"",s=Alfresco.constants.URL_SERVICECONTEXT+"modules/comments/list?nodeRef="+e[0]+"&activityType=task&entityNodeRef="+a;this._showPanel(s,this.id+"_comments",e[1])},getOverdueClass:function(t,e){var a=0,s=t.itemData.prop_pjt_projectOverdue,l=this.extractDates(t),i=null!=e?"-"+e:"";return null!=s.value&&null!=l.start&&null!=l.due&&(a=100*(s.value/(l.due.getTime()-l.start.getTime()))*24*60*60*1e3),a>45?"overdue-45plus"+i:a>30?"overdue-30to45"+i:a>15?"overdue-15to29"+i:a>0?"overdue-0to14"+i:"overdue-negative"+i},extractDates:function(t,e,a){var s=null,l=null,i=null;if(a){if(s=t.itemData.prop_pjt_tlStart.value,l=t.itemData.prop_pjt_tlEnd.value,l=null!=l?this.resetDate(Alfresco.util.fromISO8601(l)):null,s=null!=s?this.resetDate(Alfresco.util.fromISO8601(s)):this.resetDate(e),null==l){var n=t.itemData.prop_pjt_tlDuration.value;null==n&&(n=null!=t.itemData.prop_pjt_tlIsMilestone&&t.itemData.prop_pjt_tlIsMilestone.value?1:0),l=new Date(s.getTime()+24*n*60*60*1e3)}return{start:s,end:l}}return s=t.itemData.prop_pjt_projectStartDate.value,l=t.itemData.prop_pjt_projectCompletionDate.value,i=t.itemData.prop_pjt_projectDueDate.value,s=null!=s?this.resetDate(Alfresco.util.fromISO8601(s)):new Date,l=null!=l?this.resetDate(Alfresco.util.fromISO8601(l)):null,i=null!=i?this.resetDate(Alfresco.util.fromISO8601(i)):this.computeDueDate(s,t),{start:s,end:l,due:i}},computeDueDate:function(t,e){var a=e.itemData.dt_pjt_taskList,s=t,l=t;for(j in a){var i=a[j],n=i.nodeRef,o=this.cache[n];if(!o){for(var r in i.itemData.assoc_pjt_tlPrevTasks){var p=i.itemData.assoc_pjt_tlPrevTasks[r].value;null!=this.cache[p]&&null!=this.cache[p].end&&this.cache[p].end.getTime()>l.getTime()&&(l=this.cache[p].end)}o=this.extractDates(i,l,!0),this.cache[n]=o}s=o.end}return s},resetDate:function(t){return null==t?new Date:(t.setHours(0),t.setMinutes(0),t.setSeconds(0),t)},getTaskTitle:function(t,e,l,i){var n='<span class="task-status task-status-'+t.itemData.prop_pjt_tlState.value+'">',o="";return n+=t.permissions.userAccess.edit?'<span class="node-'+t.nodeRef+"|"+e+'"><a href="" class="theme-color-1 '+a+'" title="'+this.msg("link.title.task-edit")+'" >'+t.itemData.prop_pjt_tlTaskName.displayValue:'<span class="node-'+t.nodeRef+"|"+e+'">'+t.itemData.prop_pjt_tlTaskName.displayValue,"InProgress"==t.itemData.prop_pjt_tlState.value&&t.itemData.prop_pjt_completionPercent&&null!=t.itemData.prop_pjt_completionPercent.value&&(o+='<span title="'+this.msg("completion.title")+'">'+t.itemData.prop_pjt_completionPercent.displayValue+"%</span>"),t.itemData.prop_pjt_tlRealDuration&&null!=t.itemData.prop_pjt_tlRealDuration.value&&t.itemData.prop_pjt_tlRealDuration.value>t.itemData.prop_pjt_tlDuration.value&&(o.length>0&&(o+=" - "),o+='<span class="red" title="'+this.msg("overdue.title")+'">'+Alfresco.util.encodeHTML(t.itemData.prop_pjt_tlRealDuration.value-t.itemData.prop_pjt_tlDuration.value)+" "+this.msg("overdue.day")+"</span>"),o.length>0&&(n+=" ("+o+")"),t.permissions.userAccess.edit&&(n+="</a>"),n+="</span>",n+='<span class="node-'+t.nodeRef+"|"+e+'">',n+='<a class="task-comments '+s+'" title="'+this.msg("link.title.comment-task")+'" href="" >',n+=t.itemData.prop_fm_commentCount&&t.itemData.prop_fm_commentCount.value?t.itemData.prop_fm_commentCount.value:"&nbsp;",n+="</a></span></span>"},getDeliverableTitle:function(t,e){var l='<span class="delivrable-status delivrable-status-'+t.itemData.prop_pjt_dlState.value+'">',i=t.itemData.assoc_pjt_dlContent;i.length>0&&(l+='<span class="doc-file"><a title="'+this.msg("link.title.open-document")+'" href="'+beCPG.util.entityURL(i[0].siteId,i[0].value,"document")+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(i[0].displayValue,"cm:content",16)+'" /></a></span>');var n=null!=t.itemData.prop_pjt_dlUrl?t.itemData.prop_pjt_dlUrl.value:null;return null!=n&&n.length>0&&(l+='<span class="doc-url"><a title="'+this.msg("link.title.open-link")+'" href="'+n+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/link-16.png" /></a></span>'),l+=t.permissions.userAccess.edit?'<span class="node-'+t.nodeRef+"|"+e+'"><a class="theme-color-1 '+a+'" title="'+this.msg("link.title.deliverable-edit")+'" >'+t.itemData.prop_pjt_dlDescription.displayValue+"</a></span>":'<span class="node-'+t.nodeRef+"|"+e+'">'+t.itemData.prop_pjt_dlDescription.displayValue+"</span>",l+='<span class="node-'+t.nodeRef+"|"+e+'">',l+='<a class="task-comments '+s+'" title="'+this.msg("link.title.comment-task")+'" href="" >',l+=t.itemData.prop_fm_commentCount&&t.itemData.prop_fm_commentCount.value?t.itemData.prop_fm_commentCount.value:"&nbsp;",l+="</a></span>",l+="</span>"},getPriorityImg:function(t,e){var a=t.itemData.prop_pjt_projectPriority.value,s={1:"high",2:"medium",3:"low"},l=s[a+""];return'<img class="priority" src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+l+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+l))+'"/>'},getProjectTitle:function(t,a,s){var l=null,i=null,n=null,o="",r=t.itemData.prop_cm_name.displayValue,p=t.itemData.prop_bcpg_code.displayValue,u="",c="";return l=beCPG.util.entityURL(t.siteId,t.nodeRef,"pjt:project",null,"View-properties"),i=beCPG.util.entityURL(t.siteId,t.nodeRef,"pjt:project"),n=beCPG.util.entityDocumentsURL(t.siteId,t.path,r),t.version&&""!==t.version&&(o='<span class="document-version">'+t.version+"</span>"),a?(u=null!=t.itemData.prop_pjt_projectOverdue.displayValue?e(t.itemData.prop_pjt_projectOverdue.displayValue)+"&nbsp;"+this.msg("overdue.day"):"",c+='<span class="'+this.getOverdueClass(t,s?32:null)+'" title="'+u+'">'):c+='<span class="project-title"><a class="folder-link" href="'+n+'" title="'+this.msg("link.title.open-folder")+'">&nbsp;</a>',a&&(c+=this.getPriorityImg(t,s)),c+='<a class="theme-color-1" href="'+(a?n:i)+'" title="'+(a?"":this.msg("actions.entity.view-tasks"))+'">'+p+"&nbsp;-&nbsp;"+e(r)+"</a></span>"+o},getTaskColor:function(t){if(null!=t.itemData.assoc_pjt_tlTaskLegend[0]){var e=t.itemData.assoc_pjt_tlTaskLegend[0].value;for(i in this.taskLegends)if(this.taskLegends[i].id==e)return this.taskLegends[i].color.replace("#","")}return"006600"},initTaskHandlers:function(){var t=this,e=function(e,a){var s=YAHOO.Bubbling.getOwnerByTagName(a[1].anchor,"span");return null!==s&&t.onActionShowTask.call(t,s.className,s),!0};YAHOO.Bubbling.addDefaultAction(a,e);var l=function(e,a){var s=YAHOO.Bubbling.getOwnerByTagName(a[1].anchor,"span");return null!==s&&t.onActionCommentTask.call(t,s.className,s),!0};YAHOO.Bubbling.addDefaultAction(s,l)}}}();