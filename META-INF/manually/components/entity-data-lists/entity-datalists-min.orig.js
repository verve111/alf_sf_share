(function(){var g=YAHOO.util.Dom,b=YAHOO.Bubbling;var e=Alfresco.util.encodeHTML,f=Alfresco.util.combinePaths;beCPG.component.EntityDataLists=function(j){return beCPG.component.EntityDataLists.superclass.constructor.call(this,j)};YAHOO.extend(beCPG.component.EntityDataLists,Alfresco.component.DataLists,{entity:null,options:{entityNodeRef:"",listId:"",listTypes:[],sortOptions:[],showCreate:false},views:{compoList:"formulation-view",processList:"formulation-view",packagingList:"formulation-view",taskList:"gantt-view",ingLabelingList:"labeling-view"},onReady:function i(){this.widgets.spinner=new YAHOO.widget.Panel(this.id+"-waitPanel",{width:"240px",fixedcenter:true,close:false,draggable:false,zindex:99,modal:true,visible:false});this.widgets.spinner.setHeader(this.msg("message.loading"));this.widgets.spinner.setBody('<div style="text-align:center;"><img class="icon16" src="'+Alfresco.constants.URL_RESCONTEXT+'/components/images/lightbox/loading.gif" /></div>');this.widgets.spinner.render(document.body);if(this.options.showCreate){this.widgets.newList=Alfresco.util.createYUIButton(this,"newListButton",this.onNewList,{disabled:true})}this.populateDataLists({fn:function j(){this.renderDataLists();if(this.options.listId.length>0&&this.dataLists[this.options.listId]){YAHOO.Bubbling.fire("activeDataListChanged",{list:this.options.listId,dataList:this.dataLists[this.options.listId],entity:this.entity,scrollTo:true})}else{YAHOO.Bubbling.fire("hideFilter")}if(this.options.showCreate){if(this.dataListsLength===0||window.location.hash==="#new"){this.widgets.newList.fireEvent("click")}}},scope:this})},populateDataLists:function c(k){if(document.referrer===null||document.referrer.indexOf("entity-data-lists")<1){this.showLoadingAjaxSpinner(true)}var l=function m(p,u){this.showLoadingAjaxSpinner(false);var o=p.json.datalists,t,s=this;if(p.json.listTypes){this.options.listTypes=p.json.listTypes}this.dataLists={};if(p.json.container){this.containerNodeRef=new Alfresco.util.NodeRef(p.json.container)}else{this.containerNodeRef=new Alfresco.util.NodeRef(this.options.entityNodeRef)}this.entity=p.json.entity;if(this.options.showCreate){this.widgets.newList.set("disabled",!p.json.permissions.create)}if(this.options.sortOptions!=null&&this.options.sortOptions.length>0){o.sort(function(y,w){var x=500,v=500;for(var A in s.options.sortOptions){if(y.name.indexOf(s.options.sortOptions[A].id)>-1){x=s.options.sortOptions[A].sortIndex}if(w.name.indexOf(s.options.sortOptions[A].id)>-1){v=s.options.sortOptions[A].sortIndex}if(x!=500&&x!=500){break}}return x-v})}for(var q=0,r=o.length;q<r;q++){t=o[q];this.dataLists[t.name]=t}this.dataListsLength=o.length;if(k&&(typeof k.fn=="function")){k.fn.call(k.scope||this,k.obj)}};var n=function j(o){this.showLoadingAjaxSpinner(false);if(o.status==401){window.location.reload()}else{this.dataLists=null;this.containerNodeRef=null;this.widgets.newList.set("disabled",true);var p="";try{p=e(YAHOO.lang.JSON.parse(o.responseText).message)}catch(q){p=this.msg("message.error-unknown")}Alfresco.util.PopupManager.displayMessage({text:p})}};Alfresco.util.Ajax.jsonGet({url:f(Alfresco.constants.PROXY_URI,"becpg/entitylists/node",this.options.entityNodeRef.replace(":/","")),successCallback:{fn:l,obj:k,scope:this},failureCallback:{fn:n,scope:this}})},showLoadingAjaxSpinner:function(j){if(j){this.widgets.spinner.show()}else{this.widgets.spinner.hide()}},renderDataLists:function a(q){var I=this,G=g.get(this.id+"-lists"),r="selected";G.innerHTML="";var p=function n(z){return function J(){if(z!=null&&(z.indexOf("View-")<0&&I.options.listId.indexOf("View-")<0&&(I.views[z]==I.views[I.options.listId]))){var K=Selector.query("li",G);g.removeClass(K,r);g.addClass(this,r);I.options.listId=z;YAHOO.Bubbling.fire("activeDataListChanged",{list:I.options.listId,dataList:I.dataLists[I.options.listId],entity:I.entity,scrollTo:true});return false}return true}};var C=function j(J,z){return function K(L){if(z){I.onEditList(J)}Event.stopEvent(L||window.event)}};var y=function l(J,z){return function K(L){if(z){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:Alfresco.constants.PROXY_URI+"becpg/entitylist/node/"+J.nodeRef.replace(":/","")+"?state="+("Valid"==J.state?"ToValidate":"Valid"),successCallback:{fn:function(M){J.state="Valid"==J.state?"ToValidate":"Valid";Alfresco.util.PopupManager.displayMessage({text:I.msg("message.entitylist.state.change.success")});b.fire("dataListDetailsUpdated",{dataList:J})},scope:this}})}Event.stopEvent(L||window.event)}};var m=function u(J,z){return function K(L){if(z){I.onDeleteList(J)}Event.stopEvent(L||window.event)}};try{var H=this.dataLists,F,t,v=null,w,k,x,B;if(this.dataListsLength===0){G.innerHTML='<div class="no-lists">'+this.msg("message.no-lists")+"</div>"}else{w=document.createElement("ul");G.appendChild(w);for(var o in H){if(H.hasOwnProperty(o)){F=H[o];if(this.options.listId===null||this.options.listId.length<1){this.options.listId=F.name;if(this.options.sortOptions!=null&&this.options.sortOptions.length>0){for(var s in this.options.sortOptions){if(F.name.indexOf(this.options.sortOptions[s].id)>-1){if(this.options.sortOptions[s].isView){window.location.href="entity-data-lists?list="+e(F.name)+"&nodeRef="+e(this.options.entityNodeRef)}break}}}}t=F.permissions;k=document.createElement("li");k.onclick=p(F.name);x=document.createElement("a");x.title=F.description;x.href="entity-data-lists?list="+e(F.name)+"&nodeRef="+e(this.options.entityNodeRef);if(t.edit){var E=document.createElement("span");E.className="edit";E.title=this.msg("label.edit-list");E.onclick=C(F.name,true);x.appendChild(E)}if(t["delete"]){var A=document.createElement("span");A.className="delete";A.title=this.msg("label.delete-list");A.onclick=m(F.name,true);x.appendChild(A)}elState=document.createElement("span");elState.className="state";if(t.changeState&&F.name.indexOf("WUsed")<0){elState.title=this.msg("button.datalist-state.description");elState.onclick=y(F,true)}if(F.name.indexOf("WUsed")>-1){elState.className="state WUsed"}else{elState.className="state dl-"+F.name}if(F.state&&F.state.length>0){elState.className+=" "+F.state}B=document.createTextNode(F.title);x.appendChild(elState);x.appendChild(B);k.appendChild(x);w.appendChild(k);if(F.name==this.options.listId){g.addClass(k,"selected")}if(F.name==q){v=k}}}if(v){Alfresco.util.Anim.pulse(v)}}}catch(D){G.innerHTML='<span class="error">'+this.msg("message.error-unknown")+"</span>"}},onNewList:function h(p,u){var t=this.containerNodeRef.nodeRef,k="theme-bg-selected",s=this;var r=function l(y,E,x){var C=function F(H,I){return function G(){var M=Selector.query("div",y);g.removeClass(M,k);g.addClass(H,k);if("CustomView"==I){var L=g.get(E);var J=document.createElement("label");J.id=s.id+"-CustomViewLabel";J.innerHTML='<label  for="'+E+'">'+s.msg("label.view.type.header")+'<span class="mandatory-indicator">(*)</span></label>';g.insertBefore(J,L);var N=document.createElement("div");N.id=s.id+"-CustomViewName";N.className="form-field";N.innerHTML='<label for="'+s.id+'-prop_cm_name">'+s.msg("label.view.name")+':<span class="mandatory-indicator">*</span> </label><input type="text"  name="prop_cm_name" id="'+s.id+'-prop_cm_name"  class="mandatory" >';L.type="text";L.value="";g.insertAfter(N,L.parentNode)}else{var K=document.getElementById(s.id+"-CustomViewLabel");if(K){K.parentNode.removeChild(K)}K=document.getElementById(s.id+"-CustomViewName");if(K){K.parentNode.removeChild(K)}g.get(E).type="hidden";g.get(E).value=I}x.validate();return false}};var B,w,A=g.get(y);for(var z=0,D=this.options.listTypes.length;z<D;z++){B=this.options.listTypes[z];w=document.createElement("div");w.innerHTML="<h4>"+e(B.title)+"</h4><span>"+e(B.description)+"</span>";w.onclick=C(w,B.name);A.appendChild(w)}};var v=function q(w,z){Alfresco.util.populateHTML([z.id+"-dialogTitle",this.msg("label.new-list.title")],[z.id+"-dialogHeader",this.msg("label.new-list.header")],[z.id+"-dataListItemType",this.msg("label.item-type")]);r.apply(this,[z.id+"-itemTypesContainer",z.id+"-dataListItemType-field",w]);var y=function x(F,B,E,D,A,C){return(F.value.length>0)};w.addValidation(z.id+"-dataListItemType-field",y,null,null,null,{validationType:"mandatory"})};var m=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",itemId:"dl:dataList",destination:t,mode:"create",submitType:"json"});var n=new Alfresco.module.SimpleDialog(this.id+"-newList");n.setOptions({width:"33em",templateUrl:m,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:v,scope:this},onSuccess:{fn:function j(w){var z=new Alfresco.util.NodeRef(w.json.persistedObject),x=w.config.dataObj.prop_cm_title,y=this.getListTypeTitle(w.config.dataObj.prop_dl_dataListItemType);b.fire("dataListCreated");Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.success",x)})},scope:this},onFailure:{fn:function o(w){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.failure")})},scope:this}}).show()},onDeleteList:function d(o){var n=this.dataLists[o],m=this;var l=function j(q){var t=new Alfresco.util.NodeRef(q.nodeRef),s=this.getListTypeTitle(q.itemType);Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/datalists/list/node/"+t.uri,successCallback:{fn:function u(v,w){if(w.name==this.options.listId){window.location="entity-data-lists?nodeRef="+e(m.options.entityNodeRef);return}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.success")});delete this.dataLists[q.name];this.dataListsLength--;this.renderDataLists()},obj:q,scope:this},failureCallback:{fn:function r(v){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.failure")})},scope:this}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.delete-list.title"),text:this.msg("message.delete-list.description",e(n.title)),buttons:[{text:this.msg("button.delete"),handler:function k(){this.destroy();l.call(m,n)}},{text:this.msg("button.cancel"),handler:function p(){this.destroy()},isDefault:true}]})}})})();