!function(){var t=YAHOO.util.Dom,e=YAHOO.Bubbling,s=Alfresco.util.encodeHTML,i=Alfresco.util.combinePaths;beCPG.component.EntityDataLists=function(t){return beCPG.component.EntityDataLists.superclass.constructor.call(this,t)},YAHOO.extend(beCPG.component.EntityDataLists,Alfresco.component.DataLists,{entity:null,options:{entityNodeRef:"",listId:"",sortOptions:[],showCreate:!1},views:{compoList:"formulation-view",processList:"formulation-view",packagingList:"formulation-view",taskList:"gantt-view",ingLabelingList:"labeling-view"},onReady:function(){this.widgets.spinner=new YAHOO.widget.Panel(this.id+"-waitPanel",{width:"240px",fixedcenter:!0,close:!1,draggable:!1,zindex:99,modal:!0,visible:!1}),this.widgets.spinner.setHeader(this.msg("message.loading")),this.widgets.spinner.setBody('<div style="text-align:center;"><img class="icon16" src="'+Alfresco.constants.URL_RESCONTEXT+'/components/images/lightbox/loading.gif" /></div>'),this.widgets.spinner.render(document.body),this.options.showCreate&&(this.widgets.newList=Alfresco.util.createYUIButton(this,"newListButton",this.onNewList,{disabled:!0})),this.populateDataLists({fn:function(){this.renderDataLists(),this.options.listId.length>0&&this.dataLists[this.options.listId]?YAHOO.Bubbling.fire("activeDataListChanged",{list:this.options.listId,dataList:this.dataLists[this.options.listId],entity:this.entity,scrollTo:!0}):YAHOO.Bubbling.fire("hideFilter"),this.options.showCreate&&(0===this.dataListsLength||"#new"===window.location.hash)&&this.widgets.newList.fireEvent("click")},scope:this})},populateDataLists:function(t){(null===document.referrer||document.referrer.indexOf("entity-data-lists")<1)&&this.showLoadingAjaxSpinner(!0);var e=function(e,s){this.showLoadingAjaxSpinner(!1);var i,n=e.json.datalists,o=this;e.json.listTypes&&(this.options.listTypes=e.json.listTypes),this.dataLists={},e.json.container?this.containerNodeRef=new Alfresco.util.NodeRef(e.json.container):this.containerNodeRef=new Alfresco.util.NodeRef(this.options.entityNodeRef),this.entity=e.json.entity,this.options.showCreate&&this.widgets.newList.set("disabled",!e.json.permissions.create),null!=this.options.sortOptions&&this.options.sortOptions.length>0&&n.sort(function(t,e){var s=500,i=500;for(var n in o.options.sortOptions)if(t.name.indexOf(o.options.sortOptions[n].id)>-1&&(s=o.options.sortOptions[n].sortIndex),e.name.indexOf(o.options.sortOptions[n].id)>-1&&(i=o.options.sortOptions[n].sortIndex),500!=s&&500!=s)break;return s-i});for(var a=0,l=n.length;l>a;a++)i=n[a],this.dataLists[i.name]=i;this.dataListsLength=n.length,t&&"function"==typeof t.fn&&t.fn.call(t.scope||this,t.obj)},n=function(t){if(this.showLoadingAjaxSpinner(!1),401==t.status)window.location.reload();else{this.dataLists=null,this.containerNodeRef=null,this.widgets.newList.set("disabled",!0);var e="";try{e=s(YAHOO.lang.JSON.parse(t.responseText).message)}catch(i){e=this.msg("message.error-unknown")}Alfresco.util.PopupManager.displayMessage({text:e})}};Alfresco.util.Ajax.jsonGet({url:i(Alfresco.constants.PROXY_URI,"becpg/entitylists/node",this.options.entityNodeRef.replace(":/","")),successCallback:{fn:e,obj:t,scope:this},failureCallback:{fn:n,scope:this}})},showLoadingAjaxSpinner:function(t){t?this.widgets.spinner.show():this.widgets.spinner.hide()},renderDataLists:function(i){var n=this,o=t.get(this.id+"-lists"),a="selected";o.innerHTML="";var l=function(e){return function(){if(null!=e&&e.indexOf("View-")<0&&n.options.listId.indexOf("View-")<0&&n.views[e]==n.views[n.options.listId]){var s=Selector.query("li",o);return t.removeClass(s,a),t.addClass(this,a),n.options.listId=e,YAHOO.Bubbling.fire("activeDataListChanged",{list:n.options.listId,dataList:n.dataLists[n.options.listId],entity:n.entity,scrollTo:!0}),!1}return!0}},d=function(t,e){return function(s){e&&n.onEditList(t),YAHOO.util.Event.stopEvent(s||window.event)}},r=function(t,s){return function(i){s&&Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:Alfresco.constants.PROXY_URI+"becpg/entitylist/node/"+t.nodeRef.replace(":/","")+"?state="+("Valid"==t.state?"ToValidate":"Valid"),successCallback:{fn:function(s){t.state="Valid"==t.state?"ToValidate":"Valid",Alfresco.util.PopupManager.displayMessage({text:n.msg("message.entitylist.state.change.success")}),e.fire("dataListDetailsUpdated",{dataList:t})},scope:this}}),Event.stopEvent(i||window.event)}},c=function(t,e){return function(s){e&&n.onDeleteList(t),YAHOO.util.Event.stopEvent(s||window.event)}};try{var p,h,u,m,f,g,w=this.dataLists,L=null;if(0===this.dataListsLength)o.innerHTML='<div class="no-lists">'+this.msg("message.no-lists")+"</div>";else{u=document.createElement("ul"),o.appendChild(u);for(var y in w)if(w.hasOwnProperty(y)){if(p=w[y],(null===this.options.listId||this.options.listId.length<1)&&(this.options.listId=p.name,null!=this.options.sortOptions&&this.options.sortOptions.length>0))for(var v in this.options.sortOptions)if(p.name.indexOf(this.options.sortOptions[v].id)>-1){this.options.sortOptions[v].isView&&(window.location.href="entity-data-lists?list="+s(p.name)+"&nodeRef="+s(this.options.entityNodeRef));break}if(h=p.permissions,m=document.createElement("li"),m.onclick=l(p.name),f=document.createElement("a"),f.title=p.description,f.href="entity-data-lists?list="+s(p.name)+"&nodeRef="+s(this.options.entityNodeRef),h.edit){var b=document.createElement("span");b.className="edit",b.title=this.msg("label.edit-list"),b.onclick=d(p.name,!0),f.appendChild(b)}if(h["delete"]){var O=document.createElement("span");O.className="delete",O.title=this.msg("label.delete-list"),O.onclick=c(p.name,!0),f.appendChild(O)}elState=document.createElement("span"),elState.className="state",h.changeState&&p.name.indexOf("WUsed")<0&&(elState.title=this.msg("button.datalist-state.description"),elState.onclick=r(p,!0)),p.name.indexOf("WUsed")>-1?elState.className="state WUsed":elState.className="state dl-"+p.name,p.state&&p.state.length>0&&(elState.className+=" "+p.state),g=document.createTextNode(p.title),f.appendChild(elState),f.appendChild(g),m.appendChild(f),u.appendChild(m),p.name==this.options.listId&&t.addClass(m,"selected"),p.name==i&&(L=m)}L&&Alfresco.util.Anim.pulse(L)}}catch(A){o.innerHTML='<span class="error">'+this.msg("message.error-unknown")+"</span>"}},onNewList:function(i,n){var o=this.containerNodeRef.nodeRef,a="theme-bg-selected",l=this,d=function(e,i,n){for(var o,d,r=function(s,o){return function(){var d=Selector.query("div",e);if(t.removeClass(d,a),t.addClass(s,a),"CustomView"==o){var r=t.get(i),c=document.createElement("label");c.id=l.id+"-CustomViewLabel",c.innerHTML='<label  for="'+i+'">'+l.msg("label.view.type.header")+'<span class="mandatory-indicator">(*)</span></label>',t.insertBefore(c,r);var p=document.createElement("div");p.id=l.id+"-CustomViewName",p.className="form-field",p.innerHTML='<label for="'+l.id+'-prop_cm_name">'+l.msg("label.view.name")+':<span class="mandatory-indicator">*</span> </label><input type="text"  name="prop_cm_name" id="'+l.id+'-prop_cm_name"  class="mandatory" >',r.type="text",r.value="",t.insertAfter(p,r.parentNode)}else{var h=document.getElementById(l.id+"-CustomViewLabel");h&&h.parentNode.removeChild(h),h=document.getElementById(l.id+"-CustomViewName"),h&&h.parentNode.removeChild(h),t.get(i).type="hidden",t.get(i).value=o}return n.validate(),!1}},c=t.get(e),p=0,h=this.options.listTypes.length;h>p;p++)o=this.options.listTypes[p],d=document.createElement("div"),d.innerHTML="<h4>"+s(o.title)+"</h4><span>"+s(o.description)+"</span>",d.onclick=r(d,o.name),c.appendChild(d)},r=function(t,e){Alfresco.util.populateHTML([e.id+"-dialogTitle",this.msg("label.new-list.title")],[e.id+"-dialogHeader",this.msg("label.new-list.header")],[e.id+"-dataListItemType",this.msg("label.item-type")]),d.apply(this,[e.id+"-itemTypesContainer",e.id+"-dataListItemType-field",t]);var s=function(t,e,s,i,n,o){return t.value.length>0};t.addValidation(e.id+"-dataListItemType-field",s,null,null,null,{validationType:"mandatory"})},c=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",itemId:"dl:dataList",destination:o,mode:"create",submitType:"json"}),p=new Alfresco.module.SimpleDialog(this.id+"-newList");p.setOptions({width:"33em",templateUrl:c,actionUrl:null,destroyOnHide:!0,doBeforeDialogShow:{fn:r,scope:this},onSuccess:{fn:function(t){var s=(new Alfresco.util.NodeRef(t.json.persistedObject),t.config.dataObj.prop_cm_title);this.getListTypeTitle(t.config.dataObj.prop_dl_dataListItemType);e.fire("dataListCreated"),Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.success",s)})},scope:this},onFailure:{fn:function(t){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.failure")})},scope:this}}).show()},onDeleteList:function(t){var e=this.dataLists[t],i=this,n=function(t){var e=new Alfresco.util.NodeRef(t.nodeRef);this.getListTypeTitle(t.itemType);Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/datalists/list/node/"+e.uri,successCallback:{fn:function(e,n){return n.name==this.options.listId?void(window.location="entity-data-lists?nodeRef="+s(i.options.entityNodeRef)):(Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.success")}),delete this.dataLists[t.name],this.dataListsLength--,void this.renderDataLists())},obj:t,scope:this},failureCallback:{fn:function(t){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.failure")})},scope:this}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.delete-list.title"),text:this.msg("message.delete-list.description",s(e.title)),buttons:[{text:this.msg("button.delete"),handler:function(){this.destroy(),n.call(i,e)}},{text:this.msg("button.cancel"),handler:function(){this.destroy()},isDefault:!0}]})}})}();