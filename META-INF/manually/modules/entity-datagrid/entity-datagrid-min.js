!function(){var a=YAHOO.util.Dom,b=YAHOO.util.Event,c=YAHOO.util.Selector,d=YAHOO.Bubbling,e=Alfresco.util.encodeHTML,f=Alfresco.util.activateLinks;beCPG.module.EntityDataGrid=function(a,b){return beCPG.module.EntityDataGrid.superclass.constructor.call(this,"beCPG.module.EntityDataGrid",a,["button","container","datasource","datatable","paginator","animation","history"]),this.rendererHelper=beCPG.module.EntityDataRendererHelper,this.datalistMeta={},this.datalistColumns={},this.dataRequestFields=[],this.dataResponseFields=[],this.currentPage=1,this.showingMoreActions=!1,this.currentFilter={filterId:"all",filterData:""},this.selectedItems={},this.afterDataGridUpdate=[],this.extraAfterDataGridUpdate=[],this.isButtonUpDownExistsOnFtl=!1,this.scopeId="",b&&(this.scopeId=a),d.on("activeDataListChanged",this.onActiveDataListChanged,this),d.on("dataListDetailsUpdated",this.onDataListDetailsUpdated,this),d.on("refreshDataGrids",this.onDataGridRefresh,this),d.on(this.scopeId+"columnRenamed",this.onColumnRenamed,this),d.on(this.scopeId+"scopedActiveDataListChanged",this.onActiveDataListChanged,this),d.on(this.scopeId+"userAccess",this.onUserAccess,this),d.on(this.scopeId+"filterChanged",this.onFilterChanged,this),d.on(this.scopeId+"changeFilter",this.onChangeFilter,this),d.on(this.scopeId+"versionChangeFilter",this.onChangeFilter,this),d.on(this.scopeId+"dataItemCreated",this.onDataItemCreated,this),d.on(this.scopeId+"dataItemUpdated",this.onDataItemUpdated,this),d.on(this.scopeId+"dataItemsDeleted",this.onDataItemsDeleted,this),d.on(this.scopeId+"dataItemsDuplicated",this.onDataGridRefresh,this),d.on(this.scopeId+"refreshDataGrid",this.onDataGridRefresh,this),d.on(this.scopeId+"selectedItemsChanged",this.onSelectedItemsChanged,this),d.on("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this),this.deferredListPopulation=new Alfresco.util.Deferred(["onReady","onActiveDataListChanged"],{fn:this.populateDataGrid,scope:this}),this},YAHOO.extend(beCPG.module.EntityDataGrid,Alfresco.component.Base),YAHOO.lang.augmentProto(beCPG.module.EntityDataGrid,beCPG.module.EntityDataGridActions),YAHOO.lang.augmentObject(beCPG.module.EntityDataGrid.prototype,{options:{siteId:"",usePagination:!1,displayBottomPagination:!0,useFilter:!1,filterParameters:[],sortable:!1,sortUrl:null,initialPage:1,pageSize:50,initialFilter:{},actionsPopupTimeout:500,loadingMessageDelay:1e3,splitActionsAt:3,entityNodeRef:"",extraParams:null,list:"",dataUrl:Alfresco.constants.PROXY_URI+"slingshot/datalists/data/node/",itemUrl:Alfresco.constants.PROXY_URI+"slingshot/datalists/item/node/",columnsUrl:Alfresco.constants.URL_SERVICECONTEXT+"module/entity-datagrid/config/columns",saveFieldUrl:null,itemType:null,groupBy:null,sortId:null,groupFormater:null,hiddenColumns:[],extraDataParams:"&repo=true",formWidth:"34em",initHistoryManager:!0,useHistoryManager:!0,forceLoad:!1,postMethod:!0,columnFormId:null,filterFormId:"filter"},currentPage:null,queryExecutionId:null,currentFilter:null,selectedItems:null,currentActionsMenu:null,showingMoreActions:null,deferredActionsMenu:null,afterDataGridUpdate:null,extraAfterDataGridUpdate:null,datalistMeta:null,entity:null,datalistColumns:null,dataRequestFields:null,dataResponseFields:null,rendererHelper:null,scopeId:"",formsFilterRuntime:null,fnRenderCellSelected:function(){var c=this;return function(d,e,f,g){if(a.setStyle(d,"width",f.width+"px"),a.setStyle(d.parentNode,"width",f.width+"px"),c.options.sortable){var h=e.getData("permissions").userAccess;h.sort&&YAHOO.util.Dom.addClass(d.parentNode,"datagrid-sort-handle")}d.innerHTML='<input id="checkbox-'+e.getId()+'" type="checkbox" name="fileChecked" value="'+g+'"'+(c.selectedItems[g]?' checked="checked">':">")}},fnRenderCellSelectedHeader:function(){this.timeStampId=(new Date).getTime();var b="";return b+='<div id="'+this.id+"-"+this.timeStampId+'itemSelect-div" class="item-select hidden">',b+='<button id="'+this.id+"-"+this.timeStampId+'itemSelect-button" name="datagrid-itemSelect-button">&nbsp;</button>',b+='<div id="'+this.id+"-"+this.timeStampId+'itemSelect-menu" class="yuimenu">',b+='   <div class="bd">',b+="      <ul>",b+='         <li><a href="#"><span class="selectAll">'+this.msg("menu.select.all")+"</span></a></li>",b+='         <li><a href="#"><span class="selectInvert">'+this.msg("menu.select.invert")+"</span></a></li>",b+='         <li><a href="#"><span class="selectNone">'+this.msg("menu.select.none")+"</span></a></li>",b+="      </ul>",b+="   </div>",b+=" </div>",b+=" </div>"},fnRenderCellActions:function(){var c=this;return function(d,e,f,g){a.setStyle(d,"width",f.width+"px"),a.setStyle(d.parentNode,"width",f.width+"px"),d.innerHTML='<div id="'+c.id+"-actions-"+e.getId()+'" class="hidden"></div>'}},rowFormatter:function(c,d){return d.getData("color")&&d.getData("color").length>0&&"000000"!=d.getData("color")&&a.setStyle(c,"background-color",d.getData("color")),!0},_buildCellUrl:function(b){var c="document",d=null;return null!=b.metadata&&b.metadata.length&&(c="container"==b.metadata?"folder":"document"),d=b.siteId?Alfresco.constants.URL_PAGECONTEXT+"site/"+b.siteId+"/"+c+"-details?nodeRef="+b.value:Alfresco.constants.URL_PAGECONTEXT+c+"-details?nodeRef="+b.value},onReady:function(){var c=this;this.widgets.newRowButton=Alfresco.util.createYUIButton(this,"newRowButton",this.onActionCreate,{disabled:!1,value:"create"}),this.widgets.selectedItems=Alfresco.util.createYUIButton(this,"selectedItems-button",this.onSelectedItems,{type:"menu",menu:"selectedItems-menu",lazyloadmenu:!1,disabled:!0});var e=function(b,e){var f=d.getOwnerByTagName(e[1].anchor,"div");if(null!==f&&"function"==typeof c[f.className]){e[1].stop=!0;var g=c.widgets.dataTable.getRecord(e[1].target.offsetParent).getData();c[f.className].call(c,g,f)}return!0};d.addDefaultAction(c.id+"-action-link",e),d.addDefaultAction(c.id+"-show-more",e);var f=function(b,c){var e=c[1].anchor;if(null!==e){var g,f=e.rel,h={};f&&""!==f&&(c[1].stop=!0,g=f.split("|"),h={filterOwner:window.unescape(g[0]||""),filterId:window.unescape(g[1]||""),filterData:window.unescape(g[2]||"").replace("$ML$","|"),filterDisplay:window.unescape(g[3]||"")},d.fire(this.scopeId+"changeFilter",h))}return!0};if(d.addDefaultAction("filter-change",f),this.modules.actions=new Alfresco.module.DataListActions,this.modules.dataGrid=this,a.removeClass(this.id+"-selectListMessage","hidden"),this.options.useFilter){if(this.widgets.filterFormSubmit=Alfresco.util.createYUIButton(this,"filterform-submit",this.onFilterFormSubmit),this.widgets.filterFormSubmit=Alfresco.util.createYUIButton(this,"filterform-clear",this.onFilterFormClear),this.isButtonUpDownExistsOnFtl=document.getElementById(this.id+"-filterform-button-taskup")&&document.getElementById(this.id+"-filterform-button-taskdown"),this.isButtonUpDownExistsOnFtl){this.widgets.sfdbOnActionUp=Alfresco.util.createYUIButton(this,"filterform-button-taskup",this.onActionUp);var g=document.getElementById(this.id+"-filterform-button-taskup").childNodes[0];g.style.backgroundImage="url('"+Alfresco.constants.URL_RESCONTEXT+"components/images/up-arrow-16.png')",this.widgets.sfdbOnActionUp.isInit=!0,this.widgets.sfdbOnActionDown=Alfresco.util.createYUIButton(this,"filterform-button-taskdown",this.onActionDown);var g=document.getElementById(this.id+"-filterform-button-taskdown").childNodes[0];g.style.backgroundImage="url('"+Alfresco.constants.URL_RESCONTEXT+"components/images/down-arrow-16.png')"}this.widgets.filterForm=Alfresco.util.createYUIButton(this,"filterform-button",null,{type:"menu",menu:"filterform-panel",lazyloadmenu:!1}),this.widgets.filterForm.getMenu().subscribe("show",function(a,b){c.populateFilterForm()})}if(a.get("toolbar-contribs-"+this.id)){var h=a.getChildren("toolbar-contribs-"+this.id);if(h)for(var i in h)new YAHOO.util.Element("toolbar-contribs").appendChild(h[i])}this.deferredListPopulation.fulfil("onReady"),this.options.forceLoad&&this.populateDataGrid(),a.setStyle(this.id+"-body","visibility","visible")},onHistoryManagerReady:function(){d.fire(this.scopeId+"changeFilter",YAHOO.lang.merge({datagridFirstTimeNav:!0},this.options.initialFilter))},_onDataListFailure:function(b,c){Alfresco.util.PopupManager.displayPrompt({title:c.title,text:c.text,modal:!0,buttons:[{text:this.msg("button.ok"),handler:function(){this.destroy()},isDefault:!0}]})},renderDataListMeta:function(){YAHOO.lang.isObject(this.datalistMeta)&&this.datalistMeta.title&&Alfresco.util.populateHTML([this.id+"-title",e(this.datalistMeta.entityName+" - "+this.datalistMeta.title)],[this.id+"-description",f(e(this.datalistMeta.description,!0))])},populateDataGrid:function(){YAHOO.lang.isObject(this.datalistMeta)&&(this.renderDataListMeta(),Alfresco.util.Ajax.jsonGet({url:this._getColumnUrl(this.options.columnFormId),successCallback:{fn:this.onDatalistColumns,scope:this},failureCallback:{fn:this._onDataListFailure,obj:{title:this.msg("message.error.columns.title"),text:this.msg("message.error.columns.description")},scope:this}}))},_getColumnUrl:function(a){return this.options.columnsUrl+"?itemType="+encodeURIComponent(null!=this.options.itemType?this.options.itemType:this.datalistMeta.itemType)+"&list="+encodeURIComponent(null!=this.datalistMeta.name?this.datalistMeta.name:this.options.list)+(null!=a?"&formId="+a:"")},populateFilterForm:function(){if(!this.isFilterFormLoaded){var b=null!=this.datalistMeta.name?this.datalistMeta.name:this.options.list;this.isFilterFormLoaded=!0;var c=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"module/entity-datagrid/filter/form?itemKind={itemKind}&list={list}&itemId={itemId}&formId={formId}&submitType=json&showCancelButton=false&showCaption=false&showSubmitButton=false"+(null!=this.options.entityNodeRef&&this.options.entityNodeRef.length>0?"&entityNodeRef="+this.options.entityNodeRef:""),{itemKind:"type",itemId:null!=this.options.itemType?this.options.itemType:this.datalistMeta.itemType,formId:null!=this.options.filterFormId?this.options.filterFormId:"filter",list:b});Alfresco.util.Ajax.request({url:c,dataObj:{htmlid:this.id+"-filterForm"},successCallback:{fn:this.onFilterFormTemplateLoaded,scope:this},failureCallback:{fn:function(){this.isFilterFormLoaded=!1,this.widgets.filterForm.set("disabled",!0)},scope:this},scope:this,execScripts:!0})}},onFilterFormTemplateLoaded:function(c){a.get(this.id+"-filterform").innerHTML=c.serverResponse.responseText,this.widgets.filterForm.set("disabled",!1)},onFilterFormSubmit:function(){d.fire(this.scopeId+"changeFilter",{filterOwner:this.id,filterId:"filterform",filterData:YAHOO.lang.JSON.stringify(this.cleanFilterData(this.formsFilterRuntime.getFormData())).replace("|","$ML$")}),this.widgets.filterForm.getMenu().hide()},onFilterFormClear:function(){d.fire(this.scopeId+"changeFilter",{filterOwner:this.id,filterId:"all"}),this.formsFilterRuntime.reset(),this.widgets.filterForm.getMenu().hide()},cleanFilterData:function(b){var c={};if(null!=b)for(var d in b)b[d].length>0&&(c[d]=b[d]);return c},onBeforeFormRuntimeInit:function(b,c){if(null==this.formsFilterRuntime&&c[1].eventGroup==this.id+"-filterForm-form"){var d=this;this.formsFilterRuntime=c[1].runtime,this.formsFilterRuntime.validations=[],this.formsFilterRuntime.ajaxSubmit=!0,this.formsFilterRuntime._submitInvoked=function(){return d.onFilterFormSubmit(),!1}}},onDatalistColumns:function(c){this.datalistColumns=c.json.columns,this._setupHistoryManagers(),this._setupDataSource(),this._setupDataTable(),a.addClass(this.id+"-selectListMessage","hidden"),d.fire(this.scopeId+"onDatalistColumnsReady",{entityDatagrid:this}),this.options.useHistoryManager?YAHOO.util.History.onReady(this.onHistoryManagerReady,this,!0):this.onHistoryManagerReady.call(this)},_setupHistoryManagers:function(){var b=YAHOO.util.History.getBookmarkedState(this.scopeId+"filter");b=null===b?"all":YAHOO.env.ua.gecko>0?b:window.escape(b);try{for(;b!=(b=decodeURIComponent(b)););}catch(a){}var c=function(b){var c=b.split("|"),d={filterId:window.unescape(c[0]||""),filterData:window.unescape(c[1]||"").replace("$ML$","|")};return d.filterOwner=Alfresco.util.FilterManager.getOwner(d.filterId),d};if(this.options.initialFilter=c(b),YAHOO.util.History.register(this.scopeId+"filter",b,function(b){YAHOO.env.ua.gecko>0&&(b=window.unescape(b)),this._updateDataGrid.call(this,{filter:c(b)})},null,this),this.options.initHistoryManager&&this.options.useHistoryManager)try{YAHOO.util.History.initialize("yui-history-field","yui-history-iframe")}catch(a){var e=args[1];null!==e&&null!==e.entityDataGridModule&&e.entityDataGridModule.onHistoryManagerReady()}else d.fire("dataGridReady",{entityDataGridModule:this})},onFilterChanged:function(b,c){var d=c[1];null!==d&&null!==d.filterId&&(d.filterOwner=d.filterOwner||Alfresco.util.FilterManager.getOwner(d.filterId),this.currentFilter=Alfresco.util.cleanBubblingObject(d))},_setupDataSource:function(){var b=this;this.dataRequestFields=[],this.dataResponseFields=[];for(var c=0,e=this.datalistColumns.length;c<e;c++){var f=this.datalistColumns[c],g=f.name.replace(":","_"),h="property"==f.type?"prop":"assoc";if("nested"==f.dataType&&f.columns){h="dt",h+="_"+g;for(var i=0;i<f.columns.length;i++)g+="|"+f.columns[i].name.replace(":","_")}else h+="_"+g;this.dataRequestFields.push(g),this.dataResponseFields.push(h),this.datalistColumns[h]=f}this.widgets.dataSource=new YAHOO.util.DataSource(b._getDataUrl(),{connMethodPost:b.options.postMethod,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords",queryExecutionId:"queryExecutionId"}}}),b.options.postMethod&&this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON),this.widgets.dataSource.doBeforeCallback=function(c,e,f){var g=e.metadata.parent.permissions;return g&&g.userAccess&&d.fire(b.scopeId+"userAccess",{userAccess:g.userAccess}),f}},_getDataUrl:function(a){var b=null!=this.datalistMeta.nodeRef?new Alfresco.util.NodeRef(this.datalistMeta.nodeRef):null;return this.options.dataUrl+(null!=b?b.uri:"")+(null!=this.options.entityNodeRef&&this.options.entityNodeRef.length>0?"?entityNodeRef="+this.options.entityNodeRef+"&":"?")+"itemType="+encodeURIComponent(null!=this.options.itemType?this.options.itemType:this.datalistMeta.itemType)+"&dataListName="+encodeURIComponent(null!=this.datalistMeta.name?this.datalistMeta.name:this.options.list)+"&pageSize="+(null!=a?a:this.options.pageSize)+"&site="+this.options.siteId+this._buildSortParam()+this.options.extraDataParams},_setupDataTable:function(){var e=this,f=[{key:"nodeRef",label:this.fnRenderCellSelectedHeader(),sortable:!1,formatter:this.fnRenderCellSelected(),width:16}];delete e.widgets.itemSelect;for(var g=0,h=this.datalistColumns.length;g<h;g++){var i=this.datalistColumns[g],j=this.dataResponseFields[g];(this.options.hiddenColumns.length<1||!beCPG.util.contains(this.options.hiddenColumns,j))&&f.push({key:j,label:"hidden"==i.label?"":i.label,hidden:"hidden"==i.label,sortable:!0,sortOptions:{field:i.formsName,sortFunction:this.rendererHelper.getSortFunction()},formatter:this.rendererHelper.getCellFormatter(this),editor:null!=this.options.saveFieldUrl?this.rendererHelper.getCellEditor(this,i,this.options.saveFieldUrl):null})}f.push({key:"actions",label:this.msg("label.column.actions"),sortable:!1,formatter:this.fnRenderCellActions(),width:80}),YAHOO.widget.GroupedDataTable||(YAHOO.widget.GroupedDataTable=YAHOO.widget.DataTable);var k={initialLoad:!1,dynamicData:!1,MSG_EMPTY:this.msg("message.empty"),MSG_ERROR:this.msg("message.error"),MSG_NOGROUP:this.msg("message.nogroup"),MSG_SORTASC:this.msg("message.sortasc"),MSG_SORTDESC:this.msg("message.sortdesc"),paginator:null,groupBy:this.options.groupBy,groupFormater:this.options.groupFormater,formatRow:this.rowFormatter};if(null!=this.options.saveFieldUrl&&(k.selectionMode="singlecell"),this.widgets.dataTable=new YAHOO.widget.GroupedDataTable(this.id+"-grid",f,this.widgets.dataSource,k),this.options.usePagination){var l=[this.id+"-paginator"];this.options.displayBottomPagination&&l.push(this.id+"-paginatorBottom"),this.widgets.paginator=new YAHOO.widget.Paginator({containers:l,rowsPerPage:this.options.pageSize,initialPage:this.options.initialPage,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var m=function(b,c){c._updateDataGrid.call(c,{page:b.page})};this.widgets.paginator.subscribe("changeRequest",m,this),this.options.displayBottomPagination&&a.setStyle(this.id+"-datagridBarBottom","display","block"),this.widgets.paginator.getContainerNodes().length||this.widgets.paginator.set("containers",this.widgets.dataTable._defaultPaginatorContainers(!0)),this.widgets.paginator.render()}if(this.widgets.dataTable.handleDataReturnPayload=function(c,d,f){return e.widgets.paginator&&(e.widgets.paginator.set("totalRecords",d.meta.totalRecords),e.widgets.paginator.setPage(d.meta.startIndex,!0),d.meta.totalRecords>e.options.pageSize?(a.removeClass(e.id+"-paginator","hidden"),e.options.displayBottomPagination&&a.removeClass(e.id+"-paginatorBottom","hidden")):(a.addClass(e.id+"-paginator","hidden"),e.options.displayBottomPagination&&a.addClass(e.id+"-paginatorBottom","hidden"))),e.queryExecutionId=d.meta.queryExecutionId,d.meta},this.widgets.dataTable.doBeforeLoadData=function(b,c,d){if(!c||c.error)try{var f=YAHOO.lang.JSON.parse(c.responseText);e.widgets.dataTable.set("MSG_ERROR",f.message)}catch(a){e._setDefaultDataTableErrors(e.widgets.dataTable)}return 0===c.results.length&&this.fireEvent("renderEvent",{type:"renderEvent"}),!0},this.widgets.dataTable.doBeforeSortColumn=function(b,c){e.currentSort={oColumn:b,sSortDir:c};var d=this.get("sortedBy")||{},f=d.key===b.key,g=b.sortOptions&&YAHOO.lang.isFunction(b.sortOptions.sortFunction)?b.sortOptions.sortFunction:null;if(!f||g){g=g||this.get("sortFunction");var h=b.sortOptions&&b.sortOptions.field?b.sortOptions.field:b.field;this._oRecordSet.sortRecords(g,c==YAHOO.widget.DataTable.CLASS_DESC,h)}else this._oRecordSet.reverseRecords();return this.render(),this.set("sortedBy",{key:b.key,dir:c,column:b}),!1},this.widgets.dataTable.subscribe("checkboxClickEvent",function(a){var b=a.target.value;this.selectedItems[b]=a.target.checked,d.fire(this.scopeId+"selectedItemsChanged")},this,!0),this.widgets.dataTable.subscribe("beforeRenderEvent",function(){if(e.currentSort){var a=e.currentSort.oColumn,b=e.currentSort.sSortDir,c=a.sortOptions&&YAHOO.lang.isFunction(a.sortOptions.sortFunction)?a.sortOptions.sortFunction:null;if(b||c){c=c||this.rendererHelper.get("sortFunction");var d=a.sortOptions&&a.sortOptions.field?a.sortOptions.field:a.field;this._oRecordSet.sortRecords(c,b==YAHOO.widget.DataTable.CLASS_DESC,d)}}},this.widgets.dataTable,!0),this.widgets.dataTable.subscribe("renderEvent",function(){if(null==this.widgets.itemSelect&&(this.widgets.itemSelect=Alfresco.util.createYUIButton(this,e.timeStampId+"itemSelect-button",this.onItemSelect,{type:"menu",menu:e.timeStampId+"itemSelect-menu",disabled:!1}),a.removeClass(e.id+"-"+e.timeStampId+"itemSelect-div","hidden")),YAHOO.env.ua.ie<7){var b=this.widgets.dataTable.getTableEl().parentNode;b.className=b.className}for(var c=0,d=this.extraAfterDataGridUpdate.length;c<d;c++)this.extraAfterDataGridUpdate[c].call(this);for(var c=0,d=this.afterDataGridUpdate.length;c<d;c++)this.afterDataGridUpdate[c].call(this);this.afterDataGridUpdate=[],this.isButtonUpDownExistsOnFtl&&this.widgets.sfdbOnActionUp.isInit&&(this.widgets.sfdbOnActionUp.isInit=!1,this.widgets.sfdbOnActionUp.set("disabled",!0),this.widgets.sfdbOnActionDown.set("disabled",!0))},this,!0),this.widgets.dataTable.subscribe("rowMouseoverEvent",this.onEventHighlightRow,this,!0),this.widgets.dataTable.subscribe("rowMouseoutEvent",this.onEventUnhighlightRow,this,!0),null!=this.options.saveFieldUrl){var n=function(b){var c=b.target,d=e.widgets.dataTable.getTdEl(c);if(d){var f=e.widgets.dataTable.getTdEl(d);a.hasClass(f,YAHOO.widget.DataTable.CLASS_SELECTED)&&e.widgets.dataTable.onEventShowCellEditor(b)}};this.widgets.dataTable.subscribe("cellClickEvent",function(a){var b=e.widgets.dataTable.getColumn(a.target);null!=b.editor&&(e.widgets.dataTable.focus(),n(a),e.widgets.dataTable.onEventSelectCell(a))}),this.widgets.dataTable.subscribe("tbodyKeyEvent",function(a){var c=b.getCharCode(a.event);(c>47&&c<90||c>95&&c<106)&&n({target:this.getLastSelectedCell()})}),this.widgets.dataTable.subscribe("cellSelectEvent",this.widgets.dataTable.clearTextSelection)}if(this.options.sortable){var o="group-"+e.id;e.widgets.dataTable.dtdTargets={};var p=function(c){if(null!=e.widgets.dataTable.getRecord(b.getTarget(c))){var d=e.widgets.dataTable.getRecord(b.getTarget(c)).getData("permissions").userAccess;if(d.sort){var f=e.widgets.dataTable.getTrEl(b.getTarget(c)),g=null,h=new YAHOO.util.DDProxy(f.id,o),i=null,j=null,k=null;h.handleMouseDown(c.event),h.startDrag=function(){i=this.getDragEl(),j=this.getEl(),srcIndex=j.sectionRowIndex,a.setStyle(j,"visibility","hidden"),i.innerHTML="<table><tbody>"+j.innerHTML+"</tbody></table>"},h.endDrag=function(b,c){if(a.setStyle(i,"visibility","hidden"),a.setStyle(j,"visibility",""),e.options.sortUrl){var d=e.widgets.dataTable.getRecord(g);if(null!=d&&(dstData=d.getData(),srcData=e.widgets.dataTable.getRecord(j).getData(),dstData&&srcData)){var f=e.options.sortUrl+"/"+dstData.nodeRef.replace(":/","")+"?selectedNodeRefs="+srcData.nodeRef;Alfresco.util.Ajax.jsonPost({url:f,successCallback:{fn:function(b){e._updateDataGrid.call(e,{page:e.currentPage})},scope:this},failureCallback:{fn:function(b){Alfresco.util.PopupManager.displayMessage({text:e.msg("message.details.failure")})},scope:this}})}}},h.onDragOver=function(b,c){k=a.get(c),null!=k&&"tr"===k.nodeName.toLowerCase()&&(g=k.sectionRowIndex,a.addClass(c,"elementDragOverHighlight"))},h.onDragOut=function(b,c){var d=a.get(c);null!=d&&"tr"===d.nodeName.toLowerCase()&&a.removeClass(c,"elementDragOverHighlight")}}}};this.widgets.dataTable.subscribe("cellMousedownEvent",p),this.widgets.dataTable.subscribe("rowAddEvent",function(a){if(a.record){var b=a.record.getId();e.widgets.dataTable.dtdTargets[b]=new YAHOO.util.DDTarget(b,o)}}),this.widgets.dataTable.subscribe("rowDeleteEvent",function(a){if(a.record){var b=a.record.getId();e.widgets.dataTable.dtdTargets[b].unreg(),delete e.widgets.dataTable.dtdTargets[b]}})}},onItemSelect:function(c,d,e){var f=d[0],g=d[1];this.selectItems(Alfresco.util.findEventClass(g)),b.preventDefault(f)},onEventHighlightRow:function(c){this.widgets.dataTable.onEventHighlightRow.call(this.widgets.dataTable,c);var d=a.get(this.id+"-actions-"+c.target.id);if(d&&null===d.firstChild){var f=this.widgets.dataTable.getRecord(c.target.id),g=a.get(this.id+"-actionSet").cloneNode(!0);g.innerHTML=YAHOO.lang.substitute(window.unescape(g.innerHTML),this.getActionUrls(f)),g.id=d.id+"_a",a.addClass(g,"simple");var h=f.getData("permissions").userAccess,i=f.getData("actionLabels")||{};h["filter-"+this.currentFilter.filterId]=!0;var k,l,m,n,o,p,q,r,s,j=YAHOO.util.Selector.query("div",g);for(p=0,q=j.length;p<q;p++)if(k=j[p],l=k.firstChild,m=l.firstChild,m&&i[k.className]&&(m.innerHTML=e(i[k.className])),""!==l.rel)for(n=l.rel.split(","),r=0,s=n.length;r<s;r++)if(o=n[r],"~"==o.charAt(0)?!!h[o.substring(1)]:!h[o]){g.removeChild(k);break}var t=this.options.splitActionsAt;if(j=YAHOO.util.Selector.query("div",g),j.length>t){var u=a.get(this.id+"-moreActions").cloneNode(!0),v=YAHOO.util.Selector.query("div",u);a.insertBefore(v[0],j[t]),a.insertBefore(v[1],j[t]);var w=j.slice(t);for(var x in w)w.hasOwnProperty(x)&&v[1].appendChild(w[x])}d.appendChild(g)}this.showingMoreActions?this.deferredActionsMenu=d:a.hasClass(document.body,"masked")||(this.currentActionsMenu=d,a.removeClass(d,"hidden"),this.deferredActionsMenu=null)},onEventUnhighlightRow:function(c){this.widgets.dataTable.onEventUnhighlightRow.call(this.widgets.dataTable,c);var d=a.get(this.id+"-actions-"+c.target.id);this.showingMoreActions&&!a.hasClass(document.body,"masked")||(a.addClass(d,"hidden"),this.deferredActionsMenu=null)},getActionUrls:function(b){var c=YAHOO.lang.isFunction(b.getData)?b.getData():b,d=c.nodeRef;return{editMetadataUrl:"edit-dataitem?nodeRef="+d}},getSelectedItems:function(){for(var f,b=[],c=this.widgets.dataTable.getRecordSet(),d=0,e=c.getLength(),g=d;g<=e;g++)f=c.getRecord(g),null!=f&&this.selectedItems[f.getData("nodeRef")]&&b.push(f.getData());return b},selectItems:function(b){var i,j,k,e=this.widgets.dataTable.getRecordSet(),f=c.query('input[type="checkbox"]',this.widgets.dataTable.getTbodyEl()),g=0,h=f.length;switch(b){case"selectAll":k=function(a,b){return!0};break;case"selectNone":k=function(a,b){return!1};break;case"selectInvert":k=function(a,b){return!b};break;default:k=function(a,b){return b}}for(j=0;j<h;j++)i=e.getRecord(j+g),this.selectedItems[i.getData("nodeRef")]=f[j].checked=k(i.getData("type"),f[j].checked);d.fire(this.scopeId+"selectedItemsChanged")},onSelectedItemsChanged:function(b,c){var e,g,i,j,k,l,m,d=this.getSelectedItems(),f={},h=this.widgets.selectedItems.getMenu().getItems();for(l=0,m=d.length;l<m;l++){e=d[l],g=e.permissions.userAccess;for(var n in g)g.hasOwnProperty(n)&&(f[n]=void 0===f[n]?g[n]:f[n]&&g[n])}for(var n in h)if(h.hasOwnProperty(n)&&(i=h[n],k=!1,i.element.firstChild)){if(i.element.firstChild.rel&&""!==i.element.firstChild.rel){var o="sort"===i.element.firstChild.rel;for(j=i.element.firstChild.rel.split(","),l=0,m=j.length;l<m;l++)if(!f[j[l]]){k=!0;break}o&&this.isButtonUpDownExistsOnFtl&&(this.widgets.sfdbOnActionUp.set("disabled",k),this.widgets.sfdbOnActionDown.set("disabled",k))}i.cfg.setProperty("disabled",k)}this.widgets.selectedItems.set("disabled",0===d.length)},onActionDeselectAll:function(){this.selectItems("selectNone")},onUserAccess:function(b,c){var d=c[1];if(d&&d.userAccess){var e,f,g,h;for(var i in this.widgets)if(this.widgets.hasOwnProperty(i)&&(e=this.widgets[i],e.get&&null!=e.get("srcelement")&&"no-access-check"!=e.get("srcelement").className&&(e.set("disabled",!1),"string"==typeof e.get("value")))){f=e.get("value").split(",");for(var j=0,k=f.length;j<k;j++)if(f[j].indexOf("|")!==-1){h=!1,g=f[j].split("|");for(var l=0,m=g.length;l<m;l++)if(d.userAccess[g[l]]){h=!0,e.set("activePermission",g[l],!0);break}if(!h){e.set("disabled",!0);break}}else if(!d.userAccess[f[j]]){e.set("disabled",!0);break}}}},onSelectedItems:function(c,d,e){var f=d[0],g=d[1],h=Alfresco.util.findEventClass(g);h&&"function"==typeof this[h]&&this[h].call(this,this.getSelectedItems()),b.preventDefault(f)},onActionShowMore:function(d,e){var f=this;a.addClass(e.firstChild,"highlighted");var g=a.getNextSibling(e);a.removeClass(g,"hidden"),f.showingMoreActions=!0;var h=function(){b.removeListener(g,"mouseover"),b.removeListener(g,"mouseout"),a.removeClass(e.firstChild,"highlighted"),a.addClass(g,"hidden"),f.showingMoreActions=!1,null!==f.deferredActionsMenu&&(a.addClass(f.currentActionsMenu,"hidden"),f.currentActionsMenu=f.deferredActionsMenu,f.deferredActionsMenu=null,a.removeClass(f.currentActionsMenu,"hidden"))};g.hideTimerId&&window.clearTimeout(g.hideTimerId),g.hideTimerId=window.setTimeout(h,4*f.options.actionsPopupTimeout);var i=function(b,c){c.hideTimerId&&(window.clearTimeout(c.hideTimerId),c.hideTimerId=null)},j=function(d,e){var g=b.getTarget(d),i=g.relatedTarget;i===e||a.isAncestor(e,i)||(e.hideTimerId&&window.clearTimeout(e.hideTimerId),e.hideTimerId=window.setTimeout(h,f.options.actionsPopupTimeout))};b.on(g,"mouseover",i,g),b.on(g,"mouseout",j,g)},onActiveDataListChanged:function(c,d){var e=d[1];if(null!==e&&null!==e.dataList){if(null!=this.datalistMeta&&null!=this.datalistMeta.name&&(a.removeClass(this.id+"-body",this.datalistMeta.name),null!=e.dataList.name&&a.addClass(this.id+"-body",e.dataList.name)),this.datalistMeta=e.dataList,this.entity=e.entity,this.currentPage=1,this.isFilterFormLoaded=!1,this.showingMoreActions=!1,this.options.usePagination&&(this.currentPage=1),null!=this.currentFilter&&"all"!=this.currentFilter.filterId){this.currentFilter={filterId:"all",filterData:""};var f={};f[this.scopeId+"filter"]="all",YAHOO.util.History.multiNavigate(f)}this.selectedItems={},this.afterDataGridUpdate=[],this.extraAfterDataGridUpdate=[],null!=this.formsFilterRuntime&&(this.formsFilterRuntime.reset(),this.formsFilterRuntime=null),null!=this.widgets.filterForm&&this.widgets.filterForm.getMenu().hide(),null!=e.list&&(null==this.options.list||this.options.list.length<1)&&(this.options.list=e.list),this.deferredListPopulation.fulfil("onActiveDataListChanged")||this.populateDataGrid()}},onDataListDetailsUpdated:function(b,c){var d=c[1];null!==d&&null!==d.dataList&&(this.dataListMeta=d.dataList,this.renderDataListMeta())},onDataGridRefresh:function(b,c){this._updateDataGrid.call(this,{page:this.currentPage,updateOnly:!(null==c[1]||!c[1].updateOnly)&&c[1].updateOnly,callback:null!=c[1]&&c[1].updateOnly?c[1].callback:null})},onChangeFilter:function(b,c){var d=c[1];if(null!==d&&null!==d.filterId){var e=Alfresco.util.cleanBubblingObject(d),f=YAHOO.lang.substitute("{filterId}|{filterData}",e,function(a,b,c){return"undefined"==typeof b?"":window.escape(b)}),g=f.split("|");if(0===g[1].length&&(f=g[0]),d.datagridFirstTimeNav||!this.options.useHistoryManager)this._updateDataGrid.call(this,{filter:e,page:this.currentPage});else{var h={};this.options.usePagination&&(this.currentPage=1),h[this.scopeId+"filter"]=f,YAHOO.util.History.multiNavigate(h)}}},onDataItemCreated:function(b,c){var e=c[1];if(e&&null!==e.nodeRef){var f=new Alfresco.util.NodeRef(e.nodeRef),g=this.options.itemUrl+f.uri+(null!=this.options.entityNodeRef&&this.options.entityNodeRef.length>0?"?entityNodeRef="+this.options.entityNodeRef+"&":"?")+"itemType="+encodeURIComponent(null!=this.options.itemType?this.options.itemType:this.datalistMeta.itemType)+"&dataListName="+encodeURIComponent(null!=this.datalistMeta.name?this.datalistMeta.name:this.options.list)+"&site="+this.options.siteId;Alfresco.util.Ajax.jsonPost({url:g,dataObj:this._buildDataGridParams(),successCallback:{fn:function(b){if(b.json&&null!==b.json.item){var c=b.json.item,g=function(){var c=this._findRecordByParameter(f,"nodeRef");if(null!==c){var d=this.widgets.dataTable.getTrEl(c);Alfresco.util.Anim.pulse(d)}e.callback&&e.callback.call(b.json.item)};if(this.afterDataGridUpdate.push(g),null!=b.json.lastSiblingNodeRef){var h=this._findRecordByParameter(b.json.lastSiblingNodeRef,"nodeRef");if(null!==h){var i=this.widgets.dataTable.getRecordIndex(h);this.widgets.dataTable.addRow(c,i+1)}}else this.widgets.dataTable.addRow(c);d.fire("dirtyDataTable")}},scope:this},failureCallback:{fn:function(b){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create.refresh.failure")})},scope:this}})}},onDataItemUpdated:function(b,c){var e=c[1];if(e&&null!==e.nodeRef){var f=new Alfresco.util.NodeRef(e.nodeRef),g=function(){var b=this._findRecordByParameter(f,"nodeRef");if(null!==b){var c=this.widgets.dataTable.getTrEl(b);Alfresco.util.Anim.pulse(c)}e.callback&&e.callback.call(b),d.fire("dirtyDataTable")};this.afterDataGridUpdate.push(g),this._updateDataGrid.call(this,{page:this.currentPage})}},onDataItemsDeleted:function(b,c){var e=c[1];if(e&&null!==e.items){for(var f,g,h=0,i=e.items.length;h<i;h++)f=this._findRecordByParameter(e.items[h].nodeRef,"nodeRef"),null!==f&&(g=this.widgets.dataTable.getTrEl(f),Alfresco.util.Anim.fadeOut(g));var j=function(){d.fire("dirtyDataTable")};this.afterDataGridUpdate.push(j),this._updateDataGrid.call(this,{page:this.currentPage})}},onColumnRenamed:function(b,c){var d=c[1];if(d&&null!==d.columnId){var e=this.widgets.dataTable.getColumn(d.columnId);e&&(e.hidden&&this.widgets.dataTable.showColumn(e),e.label=d.label,this.widgets.dataTable.formatTheadCell(e._elThLabel,e,this.widgets.dataTable.get("sortedBy")))}},_findNextItemByParameter:function(b,c){for(var d=this.widgets.dataTable.getRecordSet(),e=0,f=d.getLength();e<f;e++)if(d.getRecord(e).getData(c)==b&&e+1!=f)return d.getRecord(e+1).getData();
return null},_findPrevItemByParameter:function(b,c){for(var d=this.widgets.dataTable.getRecordSet(),e=0,f=d.getLength();e<f;e++)if(d.getRecord(e).getData(c)==b&&e-1>=0)return d.getRecord(e-1).getData();return null},_setDefaultDataTableErrors:function(b){var c=Alfresco.util.message;b.set("MSG_EMPTY",c("message.empty","beCPG.module.EntityDataGrid")),b.set("MSG_ERROR",c("message.error","beCPG.module.EntityDataGrid"))},_updateDataGrid:function(b){b=b||{};var c=YAHOO.lang.merge({},void 0!==b.filter?b.filter:this.currentFilter),f=null,g=null,h=this,i={filter:c,page:b.page},j=function(){g&&(f=Alfresco.util.PopupManager.displayMessage({displayTime:0,text:'<span class="wait">'+e(this.msg("message.loading"))+"</span>",noEscape:!0}),YAHOO.env.ua.ie>0?this.loadingMessageShowing=!0:f.showEvent.subscribe(function(){this.loadingMessageShowing=!0},this,!0))};this._setDefaultDataTableErrors(this.widgets.dataTable),this.showingMoreActions=!1,this.loadingMessageShowing=!1,g=YAHOO.lang.later(this.options.loadingMessageDelay,this,j);var k=null;k=function(){g&&(g.cancel(),g=null),f&&(this.loadingMessageShowing?(f.destroy(),f=null):null!=k&&YAHOO.lang.later(100,h,k))};var l=function(e,f,g){if(k(),b.updateOnly&&""==this.scopeId)this.widgets.dataTable.onDataReturnUpdateRows.call(this.widgets.dataTable,e,f,g),b.callback&&b.callback.call(this);else{var h=function(){d.fire(this.scopeId+"selectedFilesChanged")};this.afterDataGridUpdate.push(h),this.afterDataGridUpdate.push(this._addSortDnD),this.currentFilter=c,this.currentPage=b.page||1,d.fire(this.scopeId+"filterChanged",c),this.widgets.dataTable.onDataReturnReplaceRows.call(this.widgets.dataTable,e,f,g)}},m=function(b,c){if(k(),this.afterDataGridUpdate=[],401==c.status)window.location.reload(!0);else try{var e=YAHOO.lang.JSON.parse(c.responseText);this.widgets.dataTable.set("MSG_ERROR",e.message),this.widgets.dataTable.showTableMessage(e.message,YAHOO.widget.DataTable.CLASS_ERROR),404==c.status&&d.fire("deactivateAllControls")}catch(a){this._setDefaultDataTableErrors(this.widgets.dataTable)}},n=this._buildDataGridParams(i);h.options.postMethod?(this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON),n=YAHOO.lang.JSON.stringify(n),Alfresco.util.CSRFPolicy.isFilterEnabled()&&this.widgets.dataSource.connMgr.initHeader(Alfresco.util.CSRFPolicy.getHeader(),Alfresco.util.CSRFPolicy.getToken(),!1)):n="&metadata="+encodeURIComponent(YAHOO.lang.JSON.stringify(n)),this.widgets.dataSource.sendRequest(n,{success:l,failure:m,scope:this})},_buildDataGridParams:function(b){var c={fields:this.dataRequestFields,page:b&&b.page?b.page:this.currentPage,queryExecutionId:this.queryExecutionId,extraParams:this.options.extraParams};return b&&b.filter&&(c.filter={filterOwner:b.filter.filterOwner,filterId:b.filter.filterId,filterData:b.filter.filterData,filterParams:this._createFilterURLParameters(b.filter,this.options.filterParameters)}),c},_buildSortParam:function(){var b="";return null!=this.options.groupBy&&this.options.groupBy.length>0&&(b+="&sort="+this.options.groupBy.replace("prop_","").replace("_",":")),null!=this.options.sortId&&(b+="&sortId="+this.options.sortId),b},_findRecordByParameter:function(b,c){for(var d=this.widgets.dataTable.getRecordSet(),e=0,f=d.getLength();e<f;e++)if(d.getRecord(e).getData(c)==b)return d.getRecord(e);return null},_createFilterURLParameters:function(b,c){if(YAHOO.lang.isString(b.filterData))for(var d,e=0,f=c.length;e<f;e++)if(d=c[e],!(b.filterId!=d.id&&"*"!=d.id||b.filterData!=d.data&&"*"!=d.data))return this._substituteParameters(d.parameters,{id:b.filterId,data:b.filterData});return null},_substituteParameters:function(a,b){var c=a.match(/{[^}]+}/g);if(c){for(var e,f,g,d={},h=0,i=c.length;h<i;h++)e=c[h].substring(1,c[h].length-1),f=e,g=new Date,/^[\-\+]?\d+(d|dt)$/.test(f)?(/^[\-\+]?\d+(d)$/.test(f)&&(g.setHours(11),g.setMinutes(59),g.setSeconds(59),g.setMilliseconds(999)),g.setDate(g.getDate()+parseInt(f)),f=g):f=b[e],d[e]=Alfresco.util.isDate(f)?Alfresco.util.toISO8601(f):f;return YAHOO.lang.substitute(a,d)}return a}},!0)}();